---
title: "Describing the NVI and Comparison the the NVI to the NDI/SVI: Results and Figures"
author: 
- "Stephen P. Uong" 
- "Contributors: Jiayi Zhou, Jeanette A. Stingone"
date: "10/28/2021"
output: 
  html_document: 
    toc: true
    toc_float: true
---

We developed a Neighborhood Vulnerability Index (NVI) to measure vulnerability to environmental pollution. We applied the Toxicological Prioritization Index (ToxPi) to integrate data across different domains, characterize neighborhood vulnerability to environmental pollution in New York City (NYC), and determine if sources of vulnerability varied across neighborhoods.

In this document, we have included code we used to generate results and figures that we used when evaluating the NVI and comparing the NVI to the Neighborhood Deprivation Index (NDI)/ Social Vulnerability Index (SVI).

### 1. Setup
We set the working directory to one folder up from the RMarkdown file.
```{r, setup}
knitr::opts_knit$set(root.dir = '..') 
```

### 2. Loading Libraries
```{r, libraries}
library(tidyverse)
library(rio)
library(skimr)
library(janitor)
library(cluster)
library(factoextra)
# library(Amelia)
# library(janitor)
# library(cluster)
# Mapping
library(sf)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(nycgeo)
library(tigris)
# Plots
library(ggpubr)
library(colorBlindness)
library(ggpattern) # Ref: https://coolbutuseless.github.io/package/ggpattern/index.html
library(gplots) # heat map

```


### 3: Importing the Index Generated from the ToxPi GUI, NVI features, NDI, and SVI
```{r}
setwd('C:/Users/steph/OneDrive - cumc.columbia.edu/Phi/My Courses/Columbia/Work/Research - Jeanette/projects/covid-vulnerability-index/comms/git nvi')

### IMPORT: Cleaned NVI data with the NVI, NVI features, and NVI clusters
tract_final <- readRDS(file = "data/processed/nvi_final.rds")
### IMPORT: NYC specific Census tract boundaries
tract_nyc_spatial <- nycgeo::nyc_boundaries(geography = "tract") %>% 
  dplyr::transmute(Tract_FIPS = geoid)
tract_nyc_county <- nycgeo::nyc_boundaries(geography = "tract") %>% 
  dplyr::as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  dplyr::transmute(Tract_FIPS = geoid,
                   county = county_name) %>% 
  dplyr::mutate(borough = case_when(
    county == 'New York' ~ 'Manhattan',
    county == 'Kings' ~ 'Brooklyn',
    county == 'Bronx' ~ 'Bronx',
    county == 'Richmond' ~ 'Staten Island',
    county == 'Queens' ~ 'Queens'
  ))
county_names <- c('New York County', 'Kings County', 'Bronx County', 'Richmond County', 'Queens County')
counties_nyc_spatial <- tigris::counties(state = 'NY', year = 2019, cb = FALSE) %>% 
  dplyr::filter(NAMELSAD %in% county_names) %>% 
  dplyr::mutate(borough = case_when(
    NAMELSAD == 'New York County' ~ 'Manhattan',
    NAMELSAD == 'Kings County' ~ 'Brooklyn',
    NAMELSAD == 'Bronx County' ~ 'Bronx',
    NAMELSAD == 'Richmond County' ~ 'Staten Island',
    NAMELSAD == 'Queens County' ~ 'Queens'
  )) %>%
  dplyr::arrange(borough) 

### IMPORT: Toxpi data before cleaning (for 8 clusters)
tract_toxpi_pre <- import('data/processed/toxpi/nvi_toxpi_results.csv')

### IMPORT: Exclusions List
tract_exclusions_list <- import("data/processed/EXCLUSION_LIST_20210628.csv")
tract_exclusions_list_id <- tract_exclusions_list %>% 
  dplyr::filter(flag_exclude_FINAL == 0) %>% 
  dplyr::transmute(SID = as.character(GEOID))

### IMPORT: NDI, SVI
ndi <- import("data/processed/NDI.NYC.2086t.csv")
svi <- import("data/raw/svi.csv")

ndi_clean <- ndi %>% dplyr::mutate(Tract_FIPS = GEOID %>% as.character() %>% str_pad(11,side="left",pad="0")) %>% dplyr::rename(ndi = NDI_score) %>% dplyr::select(Tract_FIPS, ndi) %>% 
  dplyr::left_join(tract_nyc_county, by = "Tract_FIPS")
svi_clean <- svi %>% dplyr::mutate(Tract_FIPS = FIPS %>% as.character() %>% str_pad(11,side="left",pad="0")) %>% dplyr::rename(svi = RPL_THEMES) %>% dplyr::select(Tract_FIPS, svi) %>% 
  dplyr::filter(svi != -999) %>% 
  dplyr::left_join(tract_nyc_county, by = "Tract_FIPS") %>% 
  dplyr::inner_join(tract_exclusions_list_id %>% dplyr::transmute(Tract_FIPS = SID), by = "Tract_FIPS")

## IMPORT: Race/ethnicity sensitivity analysis
tract_toxpi_pre_raceeth_no_olap <- import('data/processed/toxpi/nvi_toxpi_raceeth_no_olap_results.csv')
tract_toxpi_pre_raceeth_olap <- import('data/processed/toxpi/nvi_toxpi_raceeth_olap_results.csv')
tract_toxpi_pre_raceeth_hsub <- import('data/processed/toxpi/nvi_toxpi_raceeth_hsub_results.csv')

```

### Create spatial objects
```{r}
# Spatial: crs = "+init=epsg:2263"
  # Included
tract_final_spatial <- tract_nyc_spatial %>% 
  dplyr::inner_join(tract_final %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS") # Checked: did not exclude any tracts, 8/11
  # Excluded
tract_exclude_spatial <- tract_nyc_spatial %>% 
  dplyr::anti_join(tract_final %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS") 
```


# FIGURES
## FIGURE 1: Domains and subdomains
```{r mapping, include=FALSE}

counties_nyc_spatial2 <- counties_nyc_spatial %>% 
  arrange(borough) %>% 
  mutate(lat = c(-73.8, -74.2, -74.2, -74.2, -74.2),
         lon = c(40.85, 40.9, 40.9, 40.9, 40.9)
         ) # For: Bronx, Brooklyn, Manhattan, Queens, Staten Island

ggplot() + 
      geom_sf(data = counties_nyc_spatial, color = 'firebrick4', fill = NA, size = 1) +
    geom_sf_label_repel(data = counties_nyc_spatial2, aes(label = borough), force = 1, nudge_x = c(1, -0.2, -0.1, 1, -1), nudge_y = c(1, 0.1, 0.2, -1, -1), seed = 1) + #, force = 1, nudge_x = 20, nudge_y = 20, seed = 35
#aes(x = !!sym(lab_countylat), y = !!sym(lab_countylon), label = !!sym(lab_county))) + #, force = 1, nudge_x = 20, nudge_y = 20, seed = 35

  geom_sf(data = tract_final_spatial, aes(fill = 'red'), color = NA) +
  geom_sf(data = tract_exclude_spatial, color = "gray30", fill = "gray30") 


#### CREATE: Functions to create maps
gen_fig1_main <- function(dfin, dfexcl, dfcounties, fill_var, fill_color, fill_label, lab_county, lab_countylat, lab_countylon){
  plot_choro <- ggplot() + 
    # counties
    geom_sf(data = dfcounties, color = 'firebrick4', fill = NA, size = 1) +
    geom_sf_label_repel(data = dfcounties, aes(label = !!sym(lab_county)), force = 1, nudge_x = c(1, -0.2, -0.1, 1, -1), nudge_y = c(1, 0.1, 0.2, -1, -1), seed = 1) + #, force = 1, nudge_x = 20, nudge_y = 20, seed = 35
    # tracts
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    # tracts, excluded
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    theme_minimal() + # Alt: ggthemes::theme_map()
    ggsn::scalebar(data = dfin, dist = 20, dist_unit = "mi", height = 0.01, st.size = 5, st.dist = 0.05, transform = FALSE, model = 'WGS84', location = "bottomright") + # scale bar
    ggsn::north(data = dfcounties, location = "topleft", symbol = 10, scale = 0.10) + # north arrow, symbol = 16, scale = 0.17
        # Alt: ggspatial::annotation_north_arrow(pad_x = unit(2.5, "cm"), pad_y = unit(-1.75, "cm")) +
        # Alt: ggspatial::annotation_scale(plot_unit = "mi", pad_x = unit(7.5, "cm"), pad_y = unit(-1, "cm")) #bgcolor("lightcyan") + #snow2 
    labs(fill = fill_label) + 
    scale_fill_gradient(low = "whitesmoke", high = fill_color) + # na.value = "gray30"
    theme(legend.title = element_text(face = "bold", size = 15), # plot.title = element_text(hjust = 0.75, face = "bold", size = 15),
          legend.text = element_text(size = 12),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "right",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank()) # plot.caption = element_text(hjust = 0, size = 10, face = "italic"), legend.position = c(1,0.5), plot.background = element_rect(fill = "lightcyan")
  return(plot_choro)
}
gen_fig1_main(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfcounties = counties_nyc_spatial, fill_var = "nvi", fill_color = '#954100',
fill_label = "Neighborhood\nVulnerability Index", lab_county = 'borough', lab_countylat = 'lat', lab_countylon = 'lon')

# https://yutannihilation.github.io/ggsflabel/index.html
library(ggsflabel) # devtools::install_github("yutannihilation/ggsflabel")
?geom_sf_text_repel

gen_fig1_part <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_label_just, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    theme_minimal() + 
    scale_fill_gradient(low = "whitesmoke", high = fill_color, breaks = seq(0, 1, fill_increment)) + 
    labs(fill = fill_label) + 
    theme(legend.title = element_text(face = "bold", size = 14, vjust = fill_label_just),  # vertically center legend with its label - does not work well
          legend.text = element_text(size = 10),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "right",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank())
  return(plot_choro)
}

### CREATE: Maps
  # Overall Index
fig1_toxpi <- gen_fig1_main(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "nvi", fill_color = '#954100',
fill_label = "Neighborhood\nVulnerability Index")
  # Domain Scores
fig1_demo <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "score_demo", fill_color = '#004F7C', fill_label = "Demographics Score", fill_label_just = 0.5, fill_increment = 0.1)
fig1_econ <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "score_economic", fill_color = '#006E50', fill_label = "Economic\nIndicators Score", fill_label_just = 0.5, fill_increment = 0.2)
fig1_resd <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "score_residential", fill_color = '#A16F00', fill_label = "Residential Density\nand Characteristics\nScore", fill_label_just = 4, fill_increment = 0.2)
fig1_hlth <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "score_healthstatus", fill_color = '#8E5474', fill_label = "Health Behavior,\nOutcomes,\nPrevention Practices,\nand Access Score", fill_label_just = 4, fill_increment = 0.2)
## MERGE: Maps
  # Alt: gridExtra::grid.arrange(fig1_toxpi, fig1_demo, fig1_econ, fig1_resd, fig1_hlth, ncol = 4, nrow = 2, layout_matrix = rbind(c(1,1,2,3), c(1,1,4,5))) 
  # Ref: https://www.datanovia.com/en/lessons/combine-multiple-ggplots-into-a-figure/
fig1_part1 <- ggarrange(fig1_toxpi, fig1_demo, nrow = 2, labels = c("A","B"), align = "v", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))
fig1_part2 <- ggarrange(fig1_econ, fig1_resd, nrow = 2, labels = c("C","D"), align = "v", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))
fig1_part3 <- ggarrange(fig1_hlth, labels = "E", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))

fig1_part2 <- ggarrange(fig1_econ, ggarrange(fig1_resd, labels = "D", font.label = list(size = 25)), nrow = 2, labels = "C", align = "v", font.label = list(size = 25)) +
  theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))


## EXPORT
fig1_part1
ggsave('figs/fig1_part1.png', width = 10, height = 15) # pixels: 1200 x 900, width = 15, height = 12
fig1_part2
ggsave('figs/fig1_part2.png', width = 10, height = 15) 
fig1_part3
ggsave('figs/fig1_part3.png', width = 10, height = 8) 


```

## FIGURE 2. MAP: NVI, NDI, SVI
```{r}
#### CREATE: Functions to create maps
gen_fig2_main <- function(dfin, dfexcl, fill_var, fill_color, fill_label){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    theme_minimal() + # Alt: ggthemes::theme_map()
    ggsn::scalebar(data = dfin, dist = 20, dist_unit = "mi", height = 0.01, st.size = 5, st.dist = 0.05, transform = FALSE, model = 'WGS84', location = "topleft") + # scale bar, bottomright
    ggsn::north(data = dfin, location = "bottomright", symbol = 10, scale = 0.10) + # north arrow, symbol = 16, scale = 0.17, topleft
        # Alt: ggspatial::annotation_north_arrow(pad_x = unit(2.5, "cm"), pad_y = unit(-1.75, "cm")) +
        # Alt: ggspatial::annotation_scale(plot_unit = "mi", pad_x = unit(7.5, "cm"), pad_y = unit(-1, "cm")) #bgcolor("lightcyan") + #snow2 
    labs(fill = fill_label) + 
    #scale_fill_gradient(low = "whitesmoke", high = fill_color) + # na.value = "gray30"
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) + # cannot seem to get title to center: title.hjust = 0.5
    theme(legend.title = element_text(face = "bold", size = 15), # plot.title = element_text(hjust = 0.75, face = "bold", size = 15),
          legend.text = element_text(size = 12),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "bottom",
          legend.box = "vertical",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank())  # plot.caption = element_text(hjust = 0, size = 10, face = "italic"), legend.position = c(1,0.5), plot.background = element_rect(fill = "lightcyan")
    #guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  return(plot_choro)
}
gen_fig2_part <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_label_just, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    theme(legend.title = element_text(face = "bold", size = 14, vjust = fill_label_just),  # vertically center legend with its label - does not work well
          legend.text = element_text(size = 10),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "bottom",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank()) 
  return(plot_choro)
}

### PREP DATA
fig2_sf <- tract_final_spatial %>% 
  dplyr::select(Tract_FIPS, nvi) %>% 
  dplyr::left_join(ndi_clean, by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean, by = "Tract_FIPS") %>% 
  dplyr::mutate(nvi_q = ntile(nvi, 4) %>% as.factor(),
                ndi_q = ntile(ndi, 4) %>% as.factor(),
                svi_q = ntile(svi, 4) %>% as.factor()) 

### CREATE: Maps for NVI, NDI, SVI
red_fill <- c('#F6DECC', '#E59E66', '#d55e00', '#954100') # "#fee5d9","#fcae91","#fb6a4a","#cb181d"
fig2_toxpi <- gen_fig2_main(dfin = fig2_sf, dfexcl = tract_exclude_spatial, fill_var = "nvi_q", fill_color = red_fill, fill_label = "Neighborhood Vulnerability Index Quartile") 
fig2_ndi <- gen_fig2_part(dfin = fig2_sf, dfexcl = tract_exclude_spatial, fill_var = "ndi_q", fill_color =  red_fill, fill_label = "Neighborhood Deprivation Index Quartile", fill_label_just = 0.5, fill_increment = 0.1) 
fig2_svi <- gen_fig2_part(dfin = fig2_sf, dfexcl = tract_exclude_spatial, fill_var = "svi_q", fill_color =  red_fill, fill_label = "Social Vulnerability Index Quartile", fill_label_just = 0.5, fill_increment = 0.2) 
## MERGE: Maps
fig2 <- ggarrange(fig2_toxpi, fig2_ndi, fig2_svi, ncol = 3, labels = c("A","B","C")) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
# fig2 <- ggarrange(fig2_toxpi, ggarrange(fig2_ndi, fig2_svi, nrow = 2, labels = "B", font.label = list(size = 25)), ncol = 2, labels = "A", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 2, l = 0, "cm"))
fig2
ggsave('figs/fig2.png', width = 13, height = 6) # pixels: 1200 x 900 width = 13, height = 12

```

## FIGURE 3 / SUPPLEMENTAL FIGURE 2. Scatter plots
```{r}
### CREATE: Function to generate scatterplots
  # Ref, stat_cor: https://www.rdocumentation.org/packages/ggpubr/versions/0.4.0/topics/stat_cor
gen_fig3_scatterplot <- function(datain, var, var_label, var_breaks){
  plot_scatter <- ggplot(datain, aes(x = nvi, y = !!sym(var), color = nvi_domain)) +
    geom_point(alpha = 0.5, size = 0.8) + #  geom_smooth(method = lm) +
    ggpubr::stat_cor(aes(label = ..r.label..), method = "spearman", label.x.npc = 0.6, label.y.npc = 0.25, p.accuracy = 0.001, size = 6, color = "black") + # "~`,`~" # label.x.npc = 0.7, size = 4
    # ggpubr::stat_cor(aes(label = ..p.label..), method = "spearman", label.x.npc = 0.7, label.y.npc = 0.1, p.accuracy = 0.001, size = 4, color = "black") + # "~`,`~"
    facet_grid(county ~ nvi_domain) + 
    scale_color_manual(values = c("#D55E00","#0072B2","#009E73","#E69F00","#CC79A7")) +
    scale_x_continuous(breaks = seq(-1, 0.8, 0.2), minor_breaks = seq(-1, 0.9, 0.1)) +
    scale_y_continuous(breaks = seq(-2, 6, var_breaks), minor_breaks = seq(-2, 6, var_breaks/2)) +
    theme_bw() +
    labs(x = "Neighborhood Vulnerability Index", y = var_label) +
    theme(legend.position = "none",
          axis.title.x = element_text(size = 20, margin = margin(t = 10)),
          axis.title.y = element_text(size = 20, margin = margin(r = 10)),
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          strip.text.x = element_text(size = 15),
          strip.text.y = element_text(size = 15))
  return(plot_scatter)
}

### DATA PREP
fig3_nvi_df <- tract_final %>% 
  dplyr::select(Tract_FIPS, county, nvi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  tidyr::gather(key = nvi_domain, value = nvi, nvi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  dplyr::mutate(nvi_domain = case_when(nvi_domain == "nvi" ~ "Overall:\nNeighborhood\nVulnerability Index",
                                       nvi_domain == "score_demo" ~ "Domain:\nDemographic Score",
                                       nvi_domain == "score_economic" ~ "Domain:\nEconomic Score",
                                       nvi_domain == "score_residential" ~ "Domain:\nResidential Score",
                                       nvi_domain == "score_healthstatus" ~ "Domain:\nHealth Status Score") %>% 
                                       factor(levels = c("Overall:\nNeighborhood\nVulnerability Index","Domain:\nDemographic Score","Domain:\nEconomic Score","Domain:\nResidential Score","Domain:\nHealth Status Score")))
### MERGE with NDI/SVI data
fig3_df <- fig3_nvi_df %>%
  dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS)) %>% 
  dplyr::left_join(ndi_clean %>% dplyr::select(-county), by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean %>% dplyr::select(-county), by = "Tract_FIPS")
### CREATE: Plots
fig3_ndi <- gen_fig3_scatterplot(datain = fig3_df, var = "ndi", var_label = "Neighborhood Deprivation Index", var_breaks = 2) # NDI
figs2_svi <- gen_fig3_scatterplot(datain = fig3_df, var = "svi", var_label = "Social Vulnerability Index", var_breaks = 0.2) # SVI
### EXPORT: Plots
fig3_ndi
ggsave('figs/fig3.png', width = 15, height = 12)
figs2_svi
ggsave('figs/figs2.png', width = 15, height = 12)


```

## FIGURE 4 - PART B (CLUSTER MAP + CLUSTER PROFILE)
```{r}
## CHECK WHICH CLUSTERS TRACTS WERE IN
tract_final %>% filter(Tract_FIPS %in% c('36047051900','36081067100')) %>% select(Tract_FIPS, county, nvi, nvi_cluster, score_demo, score_economic, score_residential, score_healthstatus) # Queens tract: 4, Kings tract: 6
#View where on map: https://popfactfinder.planning.nyc.gov/#11.95/40.72281/-73.95688
# library(leaflet)
# tract_final_spatial_tempproj <- st_transform(tract_final_spatial, crs = '+proj=longlat +datum=WGS84')
# tract_final_spatial_tempproj_subset <- tract_final_spatial_tempproj %>% filter(Tract_FIPS %in% c('36047051900','36081067100'))
# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = tract_final_spatial_tempproj, color = "blue", label = tract_final$Tract_FIPS,
#               popup = c(paste0('GEOID: ', tract_final$Tract_FIPS))) %>%
#   addPolygons(data = tract_final_spatial_tempproj %>% filter(Tract_FIPS %in% c('36047051900','36081067100')), color = "red", label = tract_final_spatial_tempproj$Tract_FIPS,
#               popup = c(paste0('GEOID: ', tract_final$Tract_FIPS)))

## CREATE: PART 1 - CLUSTER PROFILES
# Colors
# Explore color options
  # colorBlindness::displayAllColors(paletteMartin, color="white")
  # colors_colorblindsafe <- paletteMartin[c(5, 6, 9, 11, 14, 15)] %>% unname()
colors_colorblindsafe <- c('#ffff6d','#ffb6db','#24ff24','#6db6ff','#920000','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nvi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
fig4b_part1_df <- tract_final %>% 
  dplyr::group_by(nvi_cluster) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nvi = mean(nvi),
                   q1_nvi = quantile(nvi, 0.25),
                   q3_nvi = quantile(nvi, 0.75),
                   iqr_nvi = paste0(round(q1_nvi, 2), "-", round(q3_nvi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nvi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nvi_cat = case_when(nvi_cat_prelim == 'mean_demo_score'         ~ nvi_cat_levels[1],
                                    nvi_cat_prelim == 'mean_economic_score'     ~ nvi_cat_levels[2],
                                    nvi_cat_prelim == 'mean_residential_score'  ~ nvi_cat_levels[3],
                                    nvi_cat_prelim == 'mean_healthstatus_score' ~ nvi_cat_levels[4]) %>% factor(nvi_cat_levels),
                nvi_cluster_label = paste0("Cluster ", nvi_cluster, " (n = ", n_obs, ",\nMean NVI = ", round(mean_nvi,2), ")"))
# Plotting
fig4b_part1_prelim <- ggplot(fig4b_part1_df, aes(x = nvi_cat, y = mean, fill = nvi_cluster_label, pattern = nvi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") +
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nvi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
fig4b_part1_plot_build <- ggplot_build(fig4b_part1_prelim)
for(i in 1:6){
  fig4b_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
fig4b_part1 <- ggplot_gtable(fig4b_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_fig4b_part2 <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
fig4b_part2 <- gen_fig4b_part2(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, fill_var = "nvi_cluster", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Vulnerability Index Cluster") 

## COMBINED PLOT
fig4b <- ggarrange(fig4b_part1, ggarrange(fig4b_part2, ggplot() + theme_void(), ncol = 2), nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
fig4b
# EXPORT
ggsave('figs/fig4_partb.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12

# View average NVI domains scores by cluster for text
fig4b_part1_df %>% distinct(nvi_cluster, mean_nvi, iqr_nvi)
tract_final %>% count(nvi_cluster, nvi_cluster_orig)

```



## SUPPLEMENTAL FIGURE 1. Box plots
```{r}
# note changed colors for overall and residential
figs1_df <- tract_final %>% 
  dplyr::select(Tract_FIPS, county, nvi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  tidyr::gather(key = index_type, value = index, nvi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  dplyr::mutate(index_type = case_when(index_type == "nvi" ~ "Overall:\nNeighborhood\nVulnerability Index",
                                       index_type == "score_demo" ~ "Domain:\nDemographic\nScore",
                                       index_type == "score_economic" ~ "Domain:\nEconomic\nScore",
                                       index_type == "score_residential" ~ "Domain:\nResidential\nScore",
                                       index_type == "score_healthstatus" ~ "Domain:\nHealth Status\nScore") %>% 
                                       factor(levels = c("Overall:\nNeighborhood\nVulnerability Index","Domain:\nDemographic\nScore","Domain:\nEconomic\nScore","Domain:\nResidential\nScore","Domain:\nHealth Status\nScore",
                                                         'Neighborhood Deprivation Index','Social Vulnerability Index')),
                part = 'NVI') %>% 
  rbind(ndi_clean %>% dplyr::mutate(index_type = 'Neighborhood Deprivation Index', part = 'NDI') %>% rename(index = ndi),
        svi_clean %>% dplyr::mutate(index_type = 'Social Vulnerability Index', part = 'SVI') %>% rename(index = svi)) 
### CREATE: Plots
  # NVI
figs1a <- ggplot(figs1_df %>% filter(part == 'NVI'), aes(y = county, x = index, fill = index_type)) +
  geom_boxplot() +
  facet_grid(index_type ~ ., scale = "free") +
  # labs(x = "Index", y = "County") +
  labs(title = "Neighborhood Vulnerability Index") +
  scale_fill_manual(values = c("#D55E00","#0072B2","#009E73","#E69F00","#CC79A7")) +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), strip.text.y = element_text(size = 20), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
  # NDI
figs1b <- ggplot(figs1_df %>% filter(part == 'NDI'), aes(y = county, x = index, fill = index_type)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#D55E00")) +
  labs(title = "Neighborhood Deprivation Index") +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
  # SVI
figs1c <- ggplot(figs1_df %>% filter(part == 'SVI'), aes(y = county, x = index, fill = index_type)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#D55E00")) +
  labs(title = "Social Vulnerability Index") +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
### EXPORT: Plots
# fig3_labs <- c("A","B","C") # c("Neighborhood Vulnerability Index","Neighborhood Deprivation Index","Social Vulnerability Index")
figs1 <- ggarrange(figs1a, figs1b, figs1c, nrow = 3, font.label = list(size = 25), align = "v", heights = c(4,1,1)) #labels = fig3_labs,
annotate_figure(figs1,left = text_grob("County", rot = 90, hjust = 1, size = 20), bottom = text_grob("Index", size = 20))
ggsave('figs/figs1.png', width = 15, height = 16)
```

### SUPPLEMENTAL TABLE 1 & INFO FOR TEXT
```{r}
# Prep data
stab1_df <- tract_final %>% 
  dplyr::left_join(ndi_clean, by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean, by = "Tract_FIPS")


# Function to generate summary stats
gen_stab1 <- function(dfin, var, var_label){
  var <- sym(var)
  overall <- dfin %>% 
    dplyr::summarize(mean = mean(!!var), sd = sd(!!var), median = median(!!var), min = min(!!var), max = max(!!var), q1 = quantile(!!var, probs = 0.25), q3 = quantile(!!var, probs = 0.75), iqr = paste0(q1 %>% round(2) %>% format(nsmall = 2),"-",q3 %>% round(2) %>% format(nsmall = 2)), median_iqr = paste0(median %>% round(2) %>% format(nsmall = 2)," (IQR = ",iqr,")"), median_iqr2 = paste0(median %>% round(2) %>% format(nsmall = 2),", IQR = ",iqr), median_iqr3 = paste0("median = ", median_iqr2)) %>% 
    dplyr::mutate(county = "Overall")
  bycounty <- dfin %>% 
    dplyr::group_by(county) %>% 
    dplyr::summarize(mean = mean(!!var), sd = sd(!!var), median = median(!!var), min = min(!!var), max = max(!!var), q1 = quantile(!!var, probs = 0.25), q3 = quantile(!!var, probs = 0.75), iqr = paste0(q1 %>% round(2) %>% format(nsmall = 2),"-",q3 %>% round(2) %>% format(nsmall = 2)), median_iqr = paste0(median %>% round(2) %>% format(nsmall = 2)," (IQR = ",iqr,")"), median_iqr2 = paste0(median %>% round(2) %>% format(nsmall = 2),", IQR = ",iqr), median_iqr3 = paste0("median = ", median_iqr2)) %>% 
    dplyr::mutate(county = paste0("   ", county))
  combined <- rbind(overall, bycounty) %>% 
    dplyr::mutate(score = var_label) %>% 
    dplyr::relocate(score, county, mean, sd, median, iqr, min, max, median_iqr, median_iqr2, median_iqr3, .before = mean)
  return(combined)
}

# Generate summary stats
stab1_full <- rbind(gen_stab1(stab1_df, "nvi", "Neighborhood Vulnerability Index (NVI)")
                   ,gen_stab1(stab1_df, "ndi", "Neighborhood Deprivation Index (NDI)")
                   ,gen_stab1(stab1_df, "svi", "Social Vulnerability Index (SVI)")
                   ,gen_stab1(stab1_df, "score_demo", "NVI Domain: Demographics")
                   ,gen_stab1(stab1_df, "score_economic", "NVI Domain: Economic Indicators")
                   ,gen_stab1(stab1_df, "score_residential", "NVI Domain: Residential Characteristics")
                   ,gen_stab1(stab1_df, "score_healthstatus", "NVI Domain: Health Status"))

# text_summary %>% View()
export(stab1_full, 'tabs/stab1_full.xlsx')

# OVERALL CORRELATIONS
cor.test(text_df$nvi, text_df$ndi, method = "spearman")
cor.test(text_df$nvi, text_df$svi, method = "spearman")


```

### SUPPLEMENTAL TABLE 4
```{r}
# Function to generate summary stats
gen_stab4 <- function(dfin, var, var_label){
  var <- sym(var)
  tab_summary <- dfin %>% 
    dplyr::summarize(mean = mean(!!var), sd = sd(!!var), median = median(!!var), min = min(!!var), max = max(!!var), q1 = quantile(!!var, probs = 0.25), q3 = quantile(!!var, probs = 0.75), iqr = paste0(q1 %>% round(2) %>% format(nsmall = 2),"-",q3 %>% round(2) %>% format(nsmall = 2)), median_iqr = paste0(median %>% round(2) %>% format(nsmall = 2)," (IQR = ",iqr,")"), median_iqr2 = paste0(median %>% round(2) %>% format(nsmall = 2),", IQR = ",iqr), median_iqr3 = paste0("median = ", median_iqr2)) %>% 
    dplyr::mutate(raceeth_cat = var_label) %>% 
    dplyr::relocate(raceeth_cat, mean, sd, median, iqr, min, max, median_iqr, median_iqr2, median_iqr3, .before = mean)
  return(tab_summary)
}
# Generate summary stats
stab4_full <- rbind(gen_stab4(tract_final, 'nvi', 'Main (No Race/Ethnicity)'),
                    gen_stab4(tract_toxpi_raceeth_olap_df, 'nvi', 'Overlapping Race/Ethnicity Categories'),
                    gen_stab4(tract_toxpi_raceeth_no_olap_df, 'nvi', 'Non-Overlapping Race/Ethnicity Categories'),
                    gen_stab4(tract_toxpi_raceeth_hsub_df, 'nvi', 'Hispanic Separate Subdomain'))

# text_summary %>% View()
export(stab4_full, 'tabs/stab4_full.xlsx')
```

### SUPPLEMENTAL TABLE 5
```{r}
# Function to generate summary stats
gen_stab5 <- function(dfin, var){
  var <- sym(var)
  var_median <- sym(paste0('median_iqr_', var))
  nvi_cluster_summary <- dfin %>% 
    dplyr::group_by(nvi_cluster) %>% 
    dplyr::summarize(iqr_prelim = quantile(!!var, c(0.25, 0.75)) %>% round(2) %>% format(2)) %>% 
    dplyr::group_by(nvi_cluster) %>% 
    dplyr::summarize(iqr = paste(iqr_prelim, collapse = '-'))
  tab_summary <- dfin %>% 
    dplyr::group_by(nvi_cluster) %>%
    dplyr::summarize(median_nvi = median(!!var) %>% round(2) %>% format(nsmall = 2)) %>% 
    dplyr::left_join(nvi_cluster_summary, by = 'nvi_cluster') %>% 
    dplyr::summarize(nvi_cluster = nvi_cluster,
                     median_iqr = paste0(median_nvi,' (',iqr,')'))
  return(tab_summary)
}
# Generate summary stats
stab5 <- tract_final %>% 
  janitor::tabyl(nvi_cluster) %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  dplyr::transmute(nvi_cluster = nvi_cluster,
                   n_percent = paste0('(n = ', n,', ', percent,')')) %>% 
  dplyr::left_join(gen_stab5(tract_final, 'nvi') %>% dplyr::rename(nvi_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_age') %>% dplyr::rename(score_demo_age_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_femaleled') %>% dplyr::rename(score_demo_femaleled_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_immigration') %>% dplyr::rename(score_demo_immigration_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_disability') %>% dplyr::rename(score_demo_disability_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_singleparent') %>% dplyr::rename(score_demo_singleparent_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_mobility') %>% dplyr::rename(score_demo_mobility_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_demo_livealone') %>% dplyr::rename(score_demo_livealone_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_incomepoverty') %>% dplyr::rename(score_economic_incomepoverty_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_servicemanual') %>% dplyr::rename(score_economic_servicemanual_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_gini') %>% dplyr::rename(score_economic_gini_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_employment') %>% dplyr::rename(score_economic_employment_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_education') %>% dplyr::rename(score_economic_education_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_economic_vehicleavail') %>% dplyr::rename(score_economic_vehicleavail_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_popdensity') %>% dplyr::rename(score_residential_popdensity_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_groupquarters') %>% dplyr::rename(score_residential_groupquarters_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_occperroom') %>% dplyr::rename(score_residential_occperroom_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_structage') %>% dplyr::rename(score_residential_structage_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_structattach') %>% dplyr::rename(score_residential_structattach_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_move1yr') %>% dplyr::rename(score_residential_move1yr_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_residential_vacancy') %>% dplyr::rename(score_residential_vacancy_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_healthstatus_lifestyle') %>% dplyr::rename(score_healthstatus_lifestyle_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_healthstatus_condition') %>% dplyr::rename(score_healthstatus_condition_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_healthstatus_preventive') %>% dplyr::rename(score_healthstatus_preventive_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(tract_final, 'score_healthstatus_lackinsurance') %>% dplyr::rename(score_healthstatus_lackinsurance_median_iqr = median_iqr)) %>% 
  t()
## EXPORT
export(stab5, 'tabs/stab5.xlsx', row.names = TRUE)







```


### FIGURE 5
```{r}
### CREATE: Heat maps to visualize clustering by subdomain
## PREPARE DATA
subdomain_label_vector <- c(
  'Age','Female-Led Households','Immigration','Disability','Single Parent Households','Transportation','Single Households',
  'Income and Poverty','Occupation','Income Inequality','Employment Status','Education','Vehicle Availability',
  'Population Density','Group Quarters','Household Density','Age of Housing Structure','Units in Housing Structure','Residential Mobility','Vacancy',
  'Health Behaviors','Health Conditions','Prevention Practices','Health Insurance Status'
)
domain_label_vector <- c('Demographic\n Domain', 'Economic Indicators\n Domain', 'Residential\n Domain', 'Health Status\n Domain')
fig5_df <- stab5 %>% 
  dplyr::as_tibble(rownames = 'subdomain') %>% 
  dplyr::filter(!row_number() %in% c(1,2,3)) %>% 
  dplyr::transmute(subdomain = subdomain,
                   cluster1 = str_sub(V1, 1L, 4L) %>% as.numeric,
                   cluster2 = str_sub(V2, 1L, 4L) %>% as.numeric,
                   cluster3 = str_sub(V3, 1L, 4L) %>% as.numeric,
                   cluster4 = str_sub(V4, 1L, 4L) %>% as.numeric,
                   cluster5 = str_sub(V5, 1L, 4L) %>% as.numeric,
                   cluster6 = str_sub(V6, 1L, 4L) %>% as.numeric,
                   subdomain_label = case_when(
                     subdomain == 'score_demo_age_median_iqr' ~ subdomain_label_vector[1],
                     subdomain == 'score_demo_femaleled_median_iqr' ~ subdomain_label_vector[2],
                     subdomain == 'score_demo_immigration_median_iqr' ~ subdomain_label_vector[3],
                     subdomain == 'score_demo_disability_median_iqr' ~ subdomain_label_vector[4],
                     subdomain == 'score_demo_singleparent_median_iqr' ~ subdomain_label_vector[5],
                     subdomain == 'score_demo_mobility_median_iqr' ~ subdomain_label_vector[6],
                     subdomain == 'score_demo_livealone_median_iqr' ~ subdomain_label_vector[7],
                     subdomain == 'score_economic_incomepoverty_median_iqr' ~ subdomain_label_vector[8],
                     subdomain == 'score_economic_servicemanual_median_iqr' ~ subdomain_label_vector[9],
                     subdomain == 'score_economic_gini_median_iqr' ~ subdomain_label_vector[10],
                     subdomain == 'score_economic_employment_median_iqr' ~ subdomain_label_vector[11],
                     subdomain == 'score_economic_education_median_iqr' ~ subdomain_label_vector[12],
                     subdomain == 'score_economic_vehicleavail_median_iqr' ~ subdomain_label_vector[13],
                     subdomain == 'score_residential_popdensity_median_iqr' ~ subdomain_label_vector[14],
                     subdomain == 'score_residential_groupquarters_median_iqr' ~ subdomain_label_vector[15],
                     subdomain == 'score_residential_occperroom_median_iqr' ~ subdomain_label_vector[16],
                     subdomain == 'score_residential_structage_median_iqr' ~ subdomain_label_vector[17],
                     subdomain == 'score_residential_structattach_median_iqr' ~ subdomain_label_vector[18],
                     subdomain == 'score_residential_move1yr_median_iqr' ~ subdomain_label_vector[19],
                     subdomain == 'score_residential_vacancy_median_iqr' ~ subdomain_label_vector[20],
                     subdomain == 'score_healthstatus_lifestyle_median_iqr' ~ subdomain_label_vector[21],
                     subdomain == 'score_healthstatus_condition_median_iqr' ~ subdomain_label_vector[22],
                     subdomain == 'score_healthstatus_preventive_median_iqr' ~ subdomain_label_vector[23],
                     subdomain == 'score_healthstatus_lackinsurance_median_iqr' ~ subdomain_label_vector[24]
                   ) %>% factor(levels = subdomain_label_vector, ordered = TRUE), 
                   domain = case_when(
                     stringr::str_detect(subdomain, 'demo') ~ domain_label_vector[1],
                     stringr::str_detect(subdomain, 'economic') ~ domain_label_vector[2],
                     stringr::str_detect(subdomain, 'residential') ~ domain_label_vector[3],
                     stringr::str_detect(subdomain, 'healthstatus') ~ domain_label_vector[4]
                   ) %>% factor(levels = domain_label_vector, ordered = TRUE)) %>%  
  dplyr::select(-subdomain) %>% 
  tidyr::pivot_longer(cols = starts_with('cluster'), names_to = 'cluster', names_prefix = 'cluster', values_to = 'median') %>% 
  dplyr::mutate(cluster_label = case_when(
    cluster == '1' ~ '1\n(n = 435)',
    cluster == '2' ~ '2\n(n = 331)',
    cluster == '3' ~ '3\n(n = 903)',
    cluster == '4' ~ '4\n(n = 5)',
    cluster == '5' ~ '5\n(n = 241)',
    cluster == '6' ~ '6\n(n = 171)'
  )) %>% 
  dplyr::group_by(subdomain_label) %>% 
  dplyr::mutate(median_scaled = scale(median))

##### CREATE: heatmap 
ggplot(data = fig5_df, aes(x = cluster_label, y = subdomain_label, fill = median_scaled)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'Cluster', y = 'Subdomain', fill = "Median Score (Scaled)") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', color = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))
## EXPORT
ggsave('figs/fig5.png', width = 10, height = 13)


## CREATE: heatmap - alt (not scaled)
ggplot(data = fig5_df, aes(x = cluster, y = subdomain_label, fill = median)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'Cluster', y = 'Subdomain', fill = "Median Score") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))
## EXPORT
ggsave('figs/fig5_unscaled.png', width = 10, height = 13)


### ARCHIVE -- MAY DELETE. Older heatmaps
library(data.table)
fig5_matrix <- stab5 %>% 
  dplyr::as_tibble(rownames = 'subdomain') %>% 
  dplyr::filter(!row_number() %in% c(1,2)) %>% 
  dplyr::arrange(desc(row_number())) %>% # Reverse row order for heat map to show in desired order
  dplyr::transmute(subdomain = subdomain,
                   cluster1 = str_sub(V1, 1L, 4L) %>% as.numeric,
                   cluster2 = str_sub(V2, 1L, 4L) %>% as.numeric,
                   cluster3 = str_sub(V3, 1L, 4L) %>% as.numeric,
                   cluster4 = str_sub(V4, 1L, 4L) %>% as.numeric,
                   cluster5 = str_sub(V5, 1L, 4L) %>% as.numeric,
                   cluster6 = str_sub(V6, 1L, 4L) %>% as.numeric) %>% 
  as.data.table() %>% 
  as.matrix(rownames = 'subdomain')
  # heatmap
heatmap(fig5_matrix, scale = 'row', Colv = NA, Rowv = NA)
  # heatmap.2
my_palette<-colorRampPalette(c("cyan","yellow", "red"))
gplots::heatmap.2(fig5_matrix,
                  cellnote = matrix(rep('test',150),ncol = 6),notecol = 'black',
                  density.info = 'none',trace = 'none',dendrogram = 'none',
                  margins = c(6,20), key = TRUE,
                  #col=my_palette,
                  scale = 'none', Rowv = FALSE, Colv = FALSE)
```




