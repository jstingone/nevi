---
title: "Developing a Neighborhood Environmental Vulnerability Index in New York City, 2019 (Zip-Code)"
author: 
- "Stephen P. Uong" 
- "Contributors: Jiayi Zhou, Jeanette A. Stingone"
date: "1/19/2022"
output: 
  html_document: 
    toc: true
    toc_float: true
---

We developed a Neighborhood Environmental Vulnerability Index (NEVI) to measure vulnerability to environmental pollution. We applied the Toxicological Prioritization Index (ToxPi) to integrate data across different domains, characterize neighborhood vulnerability to environmental pollution in New York City (NYC), and determine if sources of vulnerability varied across neighborhoods.

In this document, we have summarized our process that we followed to generate the NEVI. 

### 1. Setup
We set the working directory to one folder up from the RMarkdown file.
```{r, setup}
knitr::opts_knit$set(root.dir = '..') 
```

### 2. Loading the Libraries
First, we loaded libraries to import our previously downloaded data and downloading the Census data.
```{r, libraries}
library(tidyverse)
library(rio)
library(cluster)
library(tigris)
library(cluster)
#library(nycgeo)
```

### 3. Importing the Already Downloaded Data
We imported the: 

- 2020 Centers for Disease Control and Disease Prevention (CDC) PLACES data at the Census tract level that we previously downloaded at the following [link](https://chronicdata.cdc.gov/500-Cities-Places/PLACES-Local-Data-for-Better-Health-Census-Tract-D/cwsq-ngmh). 
- 2015-2019 5-Year Estimates from the U.S. Census American Community Survey (ACS)
- List of Census Tracts to be excluded because of 1) a population of less than 20 or 2) at least 1 missing feature for the NEVI or Neighorhood Deprivation Index (NDI), one of the indices to which the NEVI was compared. 
- Header needed to import the spreadsheet into the ToxPi Graphical User interface used to generate the NEVI
- NYC county of the Census tract

```{r error = FALSE, import_data}
setwd('C:/Users/steph/OneDrive - cumc.columbia.edu/Phi/My Courses/Columbia/Work/Research - Jeanette/projects/covid-vulnerability-index/comms/git nvi')
# Zip code list from NYC DOHMH ZCTA list, Source link: https://data.cityofnewyork.us/Health/Modified-Zip-Code-Tabulation-Areas-MODZCTA-/pri4-ifjk
list_nyc_zip <- readr::read_csv('data/raw/Modified_Zip_Code_Tabulation_Areas__MODZCTA_.csv') %>% 
  dplyr::select(ZCTA) %>% 
  tidyr::separate_rows(ZCTA, sep = ',') %>% 
  dplyr::transmute(zip = trimws(ZCTA))
# HUD USPS Tract-Zip Crosswalk, Source link: https://www.huduser.gov/portal/datasets/usps_crosswalk.html
xwalk_zip_tract <- readxl::read_excel("data/raw/ZIP_TRACT_122019.xlsx", col_types = c(rep('guess',2),rep('numeric',4)))

# INCLUSION AND EXCLUSIONS
  # INCLUDE: NYC DOHMH zip codes only
xwalk_zip_tract_nyc_prelim <- xwalk_zip_tract %>%
  dplyr::select(ZIP, TRACT, RES_RATIO) %>% 
  dplyr::rename(zip = ZIP) %>% 
  dplyr::mutate(zip = zip %>% trimws(),
                TRACT = TRACT %>% trimws()) %>% 
  dplyr::inner_join(list_nyc_zip, by = 'zip')
  # Exclusion list: Generate list of zip codes with total residential ratio = 0 (30 NYC zip codes)
list_exclude_zip_resratio0 <- xwalk_zip_tract_nyc_prelim %>% 
  dplyr::group_by(zip) %>% 
  dplyr::summarize(RES_RATIO_total = sum(RES_RATIO)) %>% 
  dplyr::filter(RES_RATIO_total == 0)
  # Exclusion list: 1) pop <20 or 2) any features missing
list_exclude_ztracts <- readr::read_csv("data/processed/sensitivity analysis/nevi zip code rescale features/EXCLUSION_LIST_ZTRACTS.csv")
list_exclude_ztracts_id <- list_exclude_ztracts %>% 
  dplyr::transmute(TRACT = as.character(GEOID))
  # Exclusion data frame
xwalk_zip_tract_nyc <- xwalk_zip_tract_nyc_prelim %>% 
  # EXCLUDE: zip codes with total residential ratio = 0
  dplyr::anti_join(list_exclude_zip_resratio0, by = 'zip') %>% 
  # EXCLUDE: tracts with 1) pop <20 or 2) any features missing
  dplyr::anti_join(list_exclude_ztracts_id, by = 'TRACT')
# FINAL LIST AFTER INCLUSION/EXCLUSION: of tracts with NYC zip code crosswalk 
list_nyc_ztracts <- xwalk_zip_tract_nyc %>% dplyr::distinct(TRACT)
# CDC PLACES data, 2020 release
PLACES_orig <- rio::import('data/raw/PLACES_2020_release.csv')
# U.S. Census, American Community Survey Data 5-Year Estimates, 2015-2019
census_nyc_ztracts <- readRDS(file = "data/processed/sensitivity analysis/nevi zip code rescale features/us_census_acs_2019_ztracts.rds")
# Headers for Toxpi GUI
header_toxpi <- read.csv("data/processed/toxpi/toxpi_header.csv", header = F, colClasses = rep("character",58))
  # For sensitivity analysis of race/ethnicity
header_toxpi_raceeth_hispsub <- read.csv("data/processed/toxpi/toxpi_header_raceeth_hispsub.csv", header = F, colClasses = rep("character",62))
header_toxpi_raceeth <- read.csv("data/processed/toxpi/toxpi_header_raceeth.csv", header = F, colClasses = rep("character",62))

```

#### 3.1. (Skipped) Downloading the Census Data
We used the following code to download data from the Census. The markdown file currently skips this code segment since we have imported the previously downloaded data above.
```{r, import_census, eval = FALSE}
# Please update with your own key if you would like to run this code.
census_api_key('YOUR_CENSUS_API_KEY') 
options(tigris_use_cache = TRUE)
# Specify county names for Census data download
county_names <- c('New York County', 'Kings County', 'Bronx County', 'Richmond County', 'Queens County')
# Specify variables desired from the Census
vars <- c(# age below, subject table
          'B11005_001E','B11005_007E','B11005_010E', # female-led households
          'B02001_001E','B02001_002E','B02001_003E','B02001_005E','B02001_004E','B02001_006E','B02001_007E','B02001_008E', # race
          'B03002_001E','B03002_003E','B03002_004E','B03002_006E','B03002_005E','B03002_007E','B03002_008E','B03002_009E', # race, non-Hispanic
          'B03003_001E','B03003_003E', # hispanic/latino
          'B06007_001E','B06007_005E','B06007_008E', # lang- less than very well
          'B16005_001E','B16005_007E','B16005_008E','B16005_012E','B16005_013E','B16005_017E','B16005_018E', # lang- not well/not at all
            'B16005_022E','B16005_023E','B16005_029E','B16005_030E','B16005_034E','B16005_035E','B16005_039E',
            'B16005_040E','B16005_044E','B16005_045E', 
          'B05005_001E','B05005_002E','B05005_007E', # US entry period
          'B05002_001E','B05002_013E', # Nativity (Foreign-born)
          'B05001_001E','B05001_006E', # U.S. Citizenship
          'B26001_001E', # Group quarters/institutionalization
          # Disability below, subject table
          'B23008_001E','B23008_008E','B23008_021E', # Single parent
          'B08101_001E','B08101_009E','B08101_025E','B08101_041E','B08101_033E','B08101_049E', # Means of transportation to work
          'B08303_001E','B08303_002E','B08303_003E','B08303_004E','B08303_005E','B08303_006E','B08303_007E', # Travel time to work
            'B08303_008E','B08303_009E','B08303_010E','B08303_011E','B08303_012E','B08303_013E',
            'B08013_001E', # Travel time to work (aggregate in minutes)
          'B07013_001E','B07013_004E','B07013_007E','B07013_010E','B07013_013E','B07013_016E', # Geographic mobility in last year
          'B11001_001E','B11001_008E', # Living alone
          'B19013_001E', # Income, median
          'C24010_001E','C24010_019E','C24010_030E','C24010_034E','C24010_055E','C24010_066E','C24010_070E', # Occupation
          'B17001_001E','B17001_002E', # Poverty in last 12 months
          'B19083_001E', # Gini index
          'B23001_013E','B23001_020E','B23001_027E','B23001_034E','B23001_041E','B23001_048E','B23001_055E','B23001_062E','B23001_069E',
          'B23001_099E','B23001_106E','B23001_113E','B23001_120E','B23001_127E','B23001_134E','B23001_141E','B23001_148E','B23001_155E',
          'B23001_015E','B23001_022E','B23001_029E','B23001_036E','B23001_043E','B23001_050E','B23001_057E','B23001_064E','B23001_071E',
          'B23001_101E','B23001_108E','B23001_115E','B23001_122E','B23001_129E','B23001_136E','B23001_143E','B23001_150E','B23001_157E', # Unemployment
          'B15003_001E','B15003_002E','B15003_003E','B15003_004E','B15003_005E','B15003_006E','B15003_007E','B15003_008E', # Education, less HS
          'B15003_009E','B15003_010E','B15003_011E','B15003_012E','B15003_013E','B15003_014E','B15003_015E','B15003_016E',
          'B08014_001E','B08014_002E', # Vehicle available, no %
            'B25046_001E', # Vehicle available, agg number
            'B08015_001E', # Vehicle used in commuting 16+ age, agg number
          'B01003_001E', # Population (need to use area for density)
          'B25010_001E','B25010_002E','B25010_003E', # Average household size
          'B25041_001E','B25041_002E','B25041_003E','B25041_004E','B25041_005E','B25041_006E','B25041_007E', # Bedrooms
          'B25014_001E','B25014_002E','B25014_003E','B25014_004E','B25014_005E','B25014_006E', # Occupants per room
            'B25014_007E','B25014_008E','B25014_009E','B25014_010E','B25014_011E','B25014_012E','B25014_013E',
          'B25035_001E', # Structure built, median year
          'B25024_001E','B25024_002E','B25024_003E','B25024_004E','B25024_005E','B25024_006E','B25024_007E', # Units in structure
            'B25024_008E','B25024_009E','B25024_010E','B25024_011E',
          'B25002_001E','B25002_003E', # vacancy status
          'B25004_001E','B25004_002E','B25004_003E','B25004_004E','B25004_005E','B25004_006E','B25004_007E', # Vacancy status
            'B25004_008E' 
          )
  # These vars sep b/c error with census tract code--> I think error in tidycensus source code & merging issues
vars_subject <- c( 
  'S0101_C02_022E','S0101_C02_030E', # age
  'S1810_C03_001E' # disability
)
# Download data from the Census (NY)
  # Note: Downloaded spatial data in order to get geographic variables (e.g. land area for population density)
census_ny <- get_acs(geography = "tract", state = "NY", variables = vars, year = 2019, survey = "acs5", output = "wide", geometry = TRUE, keep_geo_vars = TRUE) %>% 
  dplyr::as_tibble() %>% 
  dplyr::select(-geometry)
# Download data from the Census subject tables (NY)
census_ny_subject_table <- get_acs(geography = "tract", state = "NY", variables = vars_subject, year = 2019, survey = "acs5", output = "wide") %>% 
  dplyr::select(-NAME)
# Merge all Census data together by FIPS code 
census_nyc_ztracts <- census_ny %>% 
  dplyr::left_join(census_ny_subject_table, by = "GEOID") %>% 
  dplyr::inner_join(list_nyc_ztracts %>% rename(GEOID = TRACT), by = 'GEOID')
# saveRDS(census_nyc_ztracts, file = "data/processed/sensitivity analysis/nevi zip code rescale features/us_census_acs_2019_ztracts.rds")
```


### 4. Cleaning the data
#### 4.1. Cleaning the CDC PLACES Data
We first cleaned the CDC PLACES data, transforming variables so that larger values of features would correspond to greater vulnerability.
```{r}
vars_PLACES <- c('CSMOKING_CrudePrev',  'BINGE_CrudePrev',  'LPA_CrudePrev',  'OBESITY_CrudePrev',  'SLEEP_CrudePrev',  
      'BPHIGH_CrudePrev',  'BPMED_CrudePrev',  'CANCER_CrudePrev',  'CASTHMA_CrudePrev',  'CHD_CrudePrev',  
      'STROKE_CrudePrev',  'COPD_CrudePrev',  'DIABETES_CrudePrev',  'HIGHCHOL_CrudePrev',  'KIDNEY_CrudePrev',  
      'MHLTH_CrudePrev',  'PHLTH_CrudePrev',  'TEETHLOST_CrudePrev',  'CHECKUP_CrudePrev',  'COREM_CrudePrev',  
      'COREW_CrudePrev',  'DENTAL_CrudePrev',  'CERVICAL_CrudePrev',  'CHOLSCREEN_CrudePrev',  
      'COLON_SCREEN_CrudePrev', 'MAMMOUSE_CrudePrev',  'ACCESS2_CrudePrev')
PLACES_sub <- PLACES_orig %>% 
  dplyr::mutate(TRACT = TractFIPS %>% as.character() %>% trimws()) %>%
  dplyr::select(TRACT, all_of(vars_PLACES)) %>% 
  dplyr::inner_join(list_nyc_ztracts, by = 'TRACT')
PLACES_clean_zip <- xwalk_zip_tract_nyc %>% 
  dplyr::inner_join(PLACES_sub, by = 'TRACT') %>% 
  dplyr::mutate_at(.vars = vars_PLACES, .funs = funs(.*RES_RATIO)) %>% 
  dplyr::group_by(zip) %>% 
  dplyr::summarize_at(.vars = c(vars_PLACES, 'RES_RATIO'), .funs = sum) %>%
  dplyr::mutate_at(.vars = vars_PLACES, .funs = funs(./RES_RATIO)) %>% 
  dplyr::mutate(CHECKUP_CrudePrev = -CHECKUP_CrudePrev - min(-CHECKUP_CrudePrev, na.rm = TRUE),
                COREM_CrudePrev = -COREM_CrudePrev - min(-COREM_CrudePrev, na.rm = TRUE),
                COREW_CrudePrev = -COREW_CrudePrev - min(-COREW_CrudePrev, na.rm = TRUE),
                DENTAL_CrudePrev = -DENTAL_CrudePrev - min(-DENTAL_CrudePrev, na.rm = TRUE),
                CERVICAL_CrudePrev = -CERVICAL_CrudePrev - min(-CERVICAL_CrudePrev, na.rm = TRUE),
                CHOLSCREEN_CrudePrev = -CHOLSCREEN_CrudePrev - min(-CHOLSCREEN_CrudePrev, na.rm = TRUE),
                COLON_SCREEN_CrudePrev = -COLON_SCREEN_CrudePrev - min(-COLON_SCREEN_CrudePrev, na.rm = TRUE),
                MAMMOUSE_CrudePrev = -MAMMOUSE_CrudePrev - min(-MAMMOUSE_CrudePrev, na.rm = TRUE)) %>% 
  dplyr::filter(RES_RATIO != 0) %>% # EXCLUDE: 1 Zip (11430) with total RES_RATIO = 0 (b/c other census tract in zip code was not in PLACES dataset, presumably has 0 or low population so CDC PLACES estimate not provided)
  dplyr::select(-RES_RATIO)
```

#### 4.2. Cleaning the U.S. Census ACS Data
We cleaned the U.S. Census ACS data, calculating proportions, transforming features so that larger values of features would correspond to greater vulnerability. Some of the features here were included in sensitivity analyses or are were previously considered by no longer included in the toxpi index. 
```{r}
census_sub_zip <- census_nyc_ztracts %>% 
  dplyr::as_tibble() %>% 
  dplyr::transmute(TRACT = as.character(GEOID),
                   ### Demographics
                   # Age
                   prop_age_under18 = S0101_C02_022E/100,
                   prop_age_65plus = S0101_C02_030E/100, 
                   # Female-led households with children
                   female_led_hh_prop = (B11005_007E + B11005_010E)/B11005_001E,
                   # language
                   eng_lim_prop = (B16005_007E+B16005_008E+B16005_012E+B16005_013E+B16005_017E+B16005_018E+
                                     B16005_022E+B16005_023E+B16005_029E+B16005_030E+B16005_034E+B16005_035E+
                                     B16005_039E+B16005_040E+B16005_044E+B16005_045E)/B16005_001E,
                   # US entry period
                   usentry_2010_prop = B05005_002E/B05005_001E,
                   # Nativity
                   forborn_prop = B05002_013E/B05002_001E,
                   # US Citizenship
                   uscitizen_no_prop = B05001_006E/B05001_001E,
                   # Disability status
                   disability_prop = S1810_C03_001E/100,
                   # Single Parent
                   single_parent_prop = (B23008_008E+B23008_021E)/B23008_001E,
                   # Means of transportation to work
                   publictrans_taxi_mcycle_bike_walk_prop = (B08101_025E+B08101_041E+B08101_033E)/B08101_001E,
                   # Travel time
                   travel_time_work_minute = B08013_001E,
                   # living alone
                   prop_living_alone = B11001_008E/B11001_001E,
                   ### Economic Indicators
                   # Income
                   income1yr_median = B19013_001E, 
                   # Poverty
                   poverty1yr_prop = B17001_002E/B17001_001E,
                   # Occupation
                   service_manual_prop = (C24010_019E+C24010_030E+C24010_034E+C24010_055E+C24010_066E+C24010_070E)/C24010_001E,
                   # Gini index
                   gini_index = B19083_001E,
                   # Unemployment
                   unemployment_prop = (B23001_015E+B23001_022E+B23001_029E+B23001_036E+B23001_043E+B23001_050E+B23001_057E+B23001_064E+B23001_071E+B23001_101E+B23001_108E+B23001_115E+B23001_122E+B23001_129E+B23001_136E+B23001_143E+B23001_150E+B23001_157E)/(B23001_013E+B23001_020E+B23001_027E+B23001_034E+B23001_041E+B23001_048E+B23001_055E+B23001_062E+B23001_069E+B23001_099E+B23001_106E+B23001_113E+B23001_120E+B23001_127E+B23001_134E+B23001_141E+B23001_148E+B23001_155E), # among those in labor force
                   # Education
                   education_less_hs_prop = (B15003_002E+B15003_003E+B15003_004E+B15003_005E+B15003_006E+B15003_007E+B15003_008E+B15003_009E+
                                             B15003_010E+B15003_011E+B15003_012E+B15003_013E+B15003_014E+B15003_015E+B15003_016E)/B15003_001E,
                   # Vehicle
                   vehicle_avail_no_prop = B08014_002E/B08014_001E,
                   ### Residential density
                   # Population density
                   pop_density = B01003_001E/(ALAND/2589988.1103), # denom: convert square meters to square miles
                   # Group quarters
                   group_quarters_prop = B26001_001E/B01003_001E,
                   # Occupants per room
                   occ_room_1_01plus_prop = (B25014_005E+B25014_006E+B25014_007E+B25014_011E+B25014_012E+B25014_013E)/B25014_001E,
                   # Year structure built
                   B25035_001E_update = ifelse(B25035_001E == 0, 1939, B25035_001E), # Plug in 1939 for values 1939 or earlier
                   B25035_001E_update = ifelse(B25035_001E_update == 18, NA, B25035_001E_update), # Plug in missing for weird values of 18 for year for now
                   age_structure_2019 = 2019 - B25035_001E_update,
                   # Type of housing
                   str_units_1att_2plus_mobile_boat_rv_van_prop = (B25024_003E+B25024_004E+B25024_005E+B25024_006E+B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)/B25024_001E,
                   str_units_20plus = (B25024_008E+B25024_009E)/B25024_001E,
                   # Geographic mobility
                   move1yr_prop = (B07013_007E+B07013_010E+B07013_013E+B07013_016E)/B07013_001E,
                   # Housing vacancy
                   str_vacancy_prop = B25002_003E/B25002_001E
                   ) %>% 
  dplyr::select(-B25035_001E_update)
# Var list to subset
vars_census_clean <- names(census_sub_zip)[-1]
census_clean_zip_prelim <- xwalk_zip_tract_nyc %>%
  dplyr::inner_join(census_sub_zip, by = 'TRACT') %>% 
  dplyr::mutate_at(.vars = vars(-c(zip, TRACT, RES_RATIO)), .funs = funs(.*RES_RATIO)) %>% 
  dplyr::group_by(zip) %>% 
  dplyr::summarize_at(.vars = vars(vars_census_clean, 'RES_RATIO'), .funs = sum) %>% 
  dplyr::mutate_at(.vars = vars_census_clean, .funs = funs(./RES_RATIO)) %>% 
  dplyr::mutate(income1yr_neg_median = -income1yr_median - min(-income1yr_median, na.rm = TRUE)) %>% # MADE NEGATIVE B/C REVERSE DIRECTION
  dplyr::select(-income1yr_median) %>% 
  dplyr::filter(RES_RATIO != 0) %>% # EXCLUDE: 1 Zip (11430) with total RES_RATIO = 0 (b/c other census tract in zip code was not in census dataset, excluded b/c pop <20 or missing feature)
  dplyr::select(-RES_RATIO)
census_clean_zip <- census_clean_zip_prelim %>% 
  dplyr::transmute(row = row_number(),
                   zip = as.character(zip),
                   CASRN = '',
                   Name = '') %>% 
  dplyr::inner_join(census_clean_zip_prelim, by = 'zip')
```

#### 4.3. Merging the Data and Applying Exclusions
We merged the data from the CDC 500 Cities project and the U.S. Census.
```{r, include = FALSE}
# Merge with OLACES data
features_zip <- census_clean_zip %>% 
  dplyr::left_join(PLACES_clean_zip, by = 'zip') %>% 
  dplyr::rename(SID = zip)
```

#### 4.4. Adding a header to the dataset to use in the ToxPi Graphical User Interface (GUI)
We added a header needed to import the spreadsheet into the ToxPi GUI. The header contains information about the slices, slice weights, name of the slices, and color of the slices.
```{r, add_toxpi_header}
bind_toxpi_header <- function(df_header, df_features){
  colnames_features <- names(df_features)
  df_colnames_features <- data.frame(matrix(ncol = length(colnames_features), colnames_features))
  rbind(setNames(df_header, colnames_features), # header
        setNames(df_colnames_features, colnames_features),  # column names
        df_features) # features
}
toxpi_export_zip <- bind_toxpi_header(header_toxpi, features_zip)
```

### 5. Exporting the Features Used in the NEVI
We exported our data into a spreadsheet with the NEVI features and the header needed to import the spreadsheet into the ToxPi GUI.
```{r, export_features}
export(features_zip, "data/processed/sensitivity analysis/nevi zip code rescale features/nevi_features_zip_sa.csv", col.names = TRUE)
export(toxpi_export_zip, "data/processed/sensitivity analysis/nevi zip code rescale features/nevi_features_toxpi_zip_sa.csv", col.names = FALSE)
```


### 6. Generating the NEVI using the ToxPi GUI
To generate the NEVI in the ToxPi GUI, we followed the following steps:
1. Downloaded ToxPi Graphical User Interface (GUI) at this link. We used version 2.3 in our original version of the NEVI (August 2019 update): https://toxpi.org/
2. Followed the steps in the NEVI ToxPi GUI tutorial (nvi_toxpi_gui_tutorial.docx) to generate the NEVI before running the rest of the R code.


### 7: Importing the Index Generated from the ToxPi GUI
After generating the index in the ToxPi GUI, we imported the CSV file containing the index that was previously exported from the software.
```{r, import_index}
zip_toxpi_pre <- import('data/processed/sensitivity analysis/nevi zip code rescale features/nevi_toxpi_zip_sa_results.csv')
features_zip <- import('data/processed/sensitivity analysis/nevi zip code rescale features/nevi_features_zip_sa.csv')
```

### 8. Creating the NEVI Clusters 
We created clusters from the slices/subdomains for the NEVI.
```{r, create_nevi_clusters}
# CREATE: Clusters, Code from developers of toxpi
set.seed(123)
  # Get slice weights
w <- sapply(sapply(names(zip_toxpi_pre)[-c(1:5)],function(x) strsplit(x, "!")),"[",2)
w <- sapply(strsplit(w,split="/"),function(x) {y <- ifelse(length(x)==2,x[2],1);as.numeric(x[1])/as.numeric(y)})
  # Generate cluster
hc <- hclust(dist(zip_toxpi_pre[,-c(1:5)]*rep(w,each=nrow(zip_toxpi_pre))), method="complete")
nevi_cluster_zip_result <- cutree(hc, k = 3) # Cut into 3 clusters using HClusts 
  # Create data frame for cluster data
zip_nevi_cluster <- zip_toxpi_pre %>% 
  dplyr::mutate(SID = Source %>% as.character() %>% trimws(),
                nevi_cluster_orig = nevi_cluster_zip_result %>% as.factor(),
                nevi_cluster = case_when(
                  nevi_cluster_orig == "1" ~ "1", #3
                  nevi_cluster_orig == "2" ~ "2", #1
                  nevi_cluster_orig == "3" ~ "3" #2
                ) %>% as.factor()) %>% 
  dplyr::select(SID, nevi_cluster)

## 4 CLUSTERS
nevi_cluster_zip_result4 <- cutree(hc, k = 4) # Cut into 3 clusters using HClusts 
  # Create data frame for cluster data
zip_nevi_cluster4 <- zip_toxpi_pre %>% 
  dplyr::mutate(SID = Source %>% as.character() %>% trimws(),
                nevi_cluster_orig4 = nevi_cluster_zip_result4 %>% as.factor(),
                nevi_cluster4 = case_when(
                  nevi_cluster_orig4 == "1" ~ "1b",
                  nevi_cluster_orig4 == "2" ~ "1a",
                  nevi_cluster_orig4 == "3" ~ "2",
                  nevi_cluster_orig4 == "4" ~ "3",
                ) %>% as.factor()) %>% 
  dplyr::select(SID, nevi_cluster4)



## 5 CLUSTERS
nevi_cluster_zip_result5 <- cutree(hc, k = 5) # Cut into 3 clusters using HClusts 
  # Create data frame for cluster data
zip_nevi_cluster5 <- zip_toxpi_pre %>% 
  dplyr::mutate(SID = Source %>% as.character() %>% trimws(),
                nevi_cluster_orig5 = nevi_cluster_zip_result5 %>% as.factor(),
                nevi_cluster5 = case_when(
                  nevi_cluster_orig5 == "1" ~ "1b",
                  nevi_cluster_orig5 == "2" ~ "1a",
                  nevi_cluster_orig5 == "3" ~ "2a",
                  nevi_cluster_orig5 == "4" ~ "3",
                  nevi_cluster_orig5 == "5" ~ "2b",
                ) %>% as.factor()) %>% 
  dplyr::select(SID, nevi_cluster5)

```


### 8.1. Checking the clusters
Below is code we used to check the clusters to help determine how many clusters we should use.
```{r, check_clusters}
scaled_zip_toxpi_pre = scale(zip_toxpi_pre[-c(1:5)])
mydist<-function(x)dist(x, method="euclidian")
mycluster <- function(x,k) list(cluster=cutree(hclust(mydist(x), method = "complete"),k=k))
gap_stat_zip_10 <- clusGap(scaled_zip_toxpi_pre, FUN = mycluster, K.max = 10, B = 50)
library(factoextra)
fviz_gap_stat(gap_stat_zip_10) # choose ___ clusters based on this plot and what we observed when characterizing the clusters.
```


### 8. Cleaning the data from ToxPi GUI
We renamed the subdomain slices and manually calculated domain-specific scores for the NEVI.
```{r, clean_index, eval = FALSE}
# CREATE: Function to clean the data
clean_toxpi <- function(datain){
  dataout <- datain %>% 
    dplyr::rename(SID = Source, nevi = `ToxPi Score`) %>% 
    dplyr::mutate(SID = as.character(SID) %>% trimws()) %>% 
    dplyr::select(-c(`HClust Group`, `KMeans Group`, Name)) %>% 
    # Demographics Domain
    dplyr::rename_at(vars(starts_with('DemographicsAge')), funs(paste0('score_demo_age'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsFemaleLed')), funs(paste0('score_demo_femaleled'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsImmigration')), funs(paste0('score_demo_immigration'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsDisability')), funs(paste0('score_demo_disability'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsSingleParent')), funs(paste0('score_demo_singleparent'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsMobility')), funs(paste0('score_demo_mobility'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsLiveAlone')), funs(paste0('score_demo_livealone'))) %>% 
    # Economic Domain
    dplyr::rename_at(vars(starts_with('Economic IndicatorsIncomePoverty')), funs(paste0('score_economic_incomepoverty'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsServiceManualJobs')), funs(paste0('score_economic_servicemanual'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsGini')), funs(paste0('score_economic_gini'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsEmployment')), funs(paste0('score_economic_employment'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsEducation')), funs(paste0('score_economic_education'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsVehicleAvail')), funs(paste0('score_economic_vehicleavail'))) %>% 
    # Residential Domain
    dplyr::rename_at(vars(starts_with('Residential DensityPopDensity')), funs(paste0('score_residential_popdensity'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityGroupQuarters')), funs(paste0('score_residential_groupquarters'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityOccPerRoom')), funs(paste0('score_residential_occperroom'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityStrAge')), funs(paste0('score_residential_structage'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityStrAttached')), funs(paste0('score_residential_structattach'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityMove1Yr')), funs(paste0('score_residential_move1yr'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityVacancy')), funs(paste0('score_residential_vacancy'))) %>% 
    # Health status Domain
    dplyr::rename_at(vars(starts_with('Health StatusLifestyle')), funs(paste0('score_healthstatus_lifestyle'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusCondition')), funs(paste0('score_healthstatus_condition'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusPreventive')), funs(paste0('score_healthstatus_preventive'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusLackInsurance')), funs(paste0('score_healthstatus_lackinsurance'))) %>% 
    # Checked: Calculated NEVI score is same as one calculated in toxpi (just rounding differences)
    dplyr::mutate(score_demo = (score_demo_age + score_demo_femaleled + score_demo_immigration + score_demo_disability + score_demo_singleparent + score_demo_mobility + score_demo_livealone)/7,
                  score_economic = (score_economic_incomepoverty + score_economic_servicemanual + score_economic_gini + score_economic_employment + score_economic_education + score_economic_vehicleavail)/6,
                  score_residential = (score_residential_popdensity + score_residential_groupquarters + score_residential_occperroom + score_residential_structage + score_residential_structattach + score_residential_move1yr + score_residential_vacancy)/7,
                  score_healthstatus = (score_healthstatus_lifestyle + score_healthstatus_condition + score_healthstatus_preventive + score_healthstatus_lackinsurance)/4)
  return(dataout)
}

# CLEAN: Data from ToxPi GUI
zip_toxpi <- clean_toxpi(zip_toxpi_pre)
```


### 9. Merging the NEVI with the NEVI features and clusters
We merged the following data: NEVI, NEVI features, and NEVI clusters.
```{r, merge_index}
zip_final <- features_zip %>% # NEVI features
  dplyr::mutate(SID = as.character(SID)) %>% 
  dplyr::left_join(zip_toxpi, by = "SID") %>%  # NEVI (from the ToxPi GUI)
  dplyr::left_join(zip_nevi_cluster, by = "SID") %>%  # NEVI clusters
  
  dplyr::left_join(zip_nevi_cluster4, by = "SID") %>%  # NEVI clusters, 4
  dplyr::left_join(zip_nevi_cluster5, by = "SID") %>%  # NEVI clusters, 5
  
  dplyr::rename(ZIP = SID) %>% 
  dplyr::relocate(nevi, nevi_cluster, score_demo, score_economic, score_residential, score_healthstatus, .after = ZIP) %>% 
  dplyr::select(-c(row, CASRN, Name)) 
```


### 10. Exporting the final data with the NEVI, features, and clusters
After completing all importing and data cleaning steps, we exported our final dataset, which included the NEVI, NEVI features, and NEVI clusters.
```{r, export_final_data}
export(zip_final, paste0("data/processed/sensitivity analysis/nevi zip code rescale features/nevi_zip_final_sa.csv"))
saveRDS(zip_final, file = "data/processed/sensitivity analysis/nevi zip code rescale features/nevi_zip_final_sa.rds")
```


### Create spatial objects
```{r}

library(ggpubr)
library(sf)

# Spatial
  # Included
zip_final_spatial <- tigris::zctas(state = 'NY', year = 2010, cb = FALSE) %>% 
  dplyr::rename(ZIP = ZCTA5CE10) %>% 
  dplyr::inner_join(zip_final, by = 'ZIP')
  # Excluded

##????
county_names <- c('New York County', 'Kings County', 'Bronx County', 'Richmond County', 'Queens County')
counties_nyc <- tigris::counties(state = 'NY', year = 2010, cb = FALSE) %>% 
  dplyr::filter(NAMELSAD10 %in% county_names)
zip_exclude_spatial <- tigris::zctas(state = 'NY', year = 2010, cb = FALSE) %>% 
  dplyr::rename(ZIP = ZCTA5CE10) %>% 
  dplyr::anti_join(zip_final, by = 'ZIP') %>% # exclude zip codes with NEVI value
  sf::st_intersection(counties_nyc) # keep only zip codes intersecting with NYC counties
  
tract_exclude_spatial <- tract_nyc_spatial %>% 
  dplyr::anti_join(tract_final %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS") 
```

# 3 CLUSTERS
## FIGURE 4 IN MS - PART B (CLUSTER MAP + CLUSTER PROFILE)
```{r}
## CREATE: PART 1 - CLUSTER PROFILES
# Colors
# Explore color options
  # colorBlindness::displayAllColors(paletteMartin, color="white")
  # colors_colorblindsafe <- paletteMartin[c(5, 6, 9, 11, 14, 15)] %>% unname()
colors_colorblindsafe <- c('#ffff6d','#ffb6db','#24ff24','#6db6ff','#920000','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nevi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
fig4b_part1_df <- zip_final %>% 
  dplyr::group_by(nevi_cluster) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nevi = mean(nevi),
                   q1_nevi = quantile(nevi, 0.25),
                   q3_nevi = quantile(nevi, 0.75),
                   iqr_nevi = paste0(round(q1_nevi, 2), "-", round(q3_nevi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nevi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nevi_cat = case_when(nevi_cat_prelim == 'mean_demo_score'         ~ nevi_cat_levels[1],
                                     nevi_cat_prelim == 'mean_economic_score'     ~ nevi_cat_levels[2],
                                     nevi_cat_prelim == 'mean_residential_score'  ~ nevi_cat_levels[3],
                                     nevi_cat_prelim == 'mean_healthstatus_score' ~ nevi_cat_levels[4]) %>% factor(nevi_cat_levels),
                nevi_cluster_label = paste0("Cluster ", nevi_cluster, " (n = ", n_obs, ",\nMean NVI = ", round(mean_nevi,2), ")"))
# Plotting
fig4b_part1_prelim <- ggplot(fig4b_part1_df, aes(x = nevi_cat, y = mean, fill = nevi_cluster_label, pattern = nevi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") +
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nevi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
fig4b_part1_plot_build <- ggplot_build(fig4b_part1_prelim)
for(i in 1:3){
  fig4b_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
fig4b_part1 <- ggplot_gtable(fig4b_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_fig4b_part2 <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
fig4b_part2 <- gen_fig4b_part2(dfin = zip_final_spatial, dfexcl = zip_exclude_spatial, fill_var = "nevi_cluster", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Environmental Vulnerability Index Cluster") 

## COMBINED PLOT
fig4b <- ggarrange(fig4b_part1, ggarrange(fig4b_part2, ggplot() + theme_void(), ncol = 2), nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
fig4b
# EXPORT
#ggsave('figs/fig4_partb_zip.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12

# View average NVI domains scores by cluster for text
fig4b_part1_df %>% distinct(nvi_cluster, mean_nvi, iqr_nvi)
tract_final %>% count(nvi_cluster, nvi_cluster_orig)

```
### FIGURE 5 IN MS (HEATMAP)
```{r}
### CREATE: Heat maps to visualize clustering by subdomain
## PREPARE DATA
subdomain_label_vector <- c(
  'Age','Female-Led Households','Immigration','Disability','Single Parent Households','Transportation','Single Households',
  'Income and Poverty','Occupation','Income Inequality','Employment Status','Education','Vehicle Availability',
  'Population Density','Group Quarters','Household Density','Age of Housing Structure','Units in Housing Structure','Residential Mobility','Vacancy',
  'Health Behaviors','Health Conditions','Prevention Practices','Health Insurance Status'
)
domain_label_vector <- c('Demographic\n Domain', 'Economic Indicators\n Domain', 'Residential\n Domain', 'Health Status\n Domain')
gen_stab5 <- function(dfin, var){
  var <- sym(var)
  var_median <- sym(paste0('median_iqr_', var))
  nevi_cluster_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster) %>% 
    dplyr::summarize(iqr_prelim = quantile(!!var, c(0.25, 0.75)) %>% round(2) %>% format(2)) %>% 
    dplyr::group_by(nevi_cluster) %>% 
    dplyr::summarize(iqr = paste(iqr_prelim, collapse = '-'))
  tab_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster) %>%
    dplyr::summarize(median_nevi = median(!!var) %>% round(2) %>% format(nsmall = 2)) %>% 
    dplyr::left_join(nevi_cluster_summary, by = 'nevi_cluster') %>% 
    dplyr::summarize(nevi_cluster = nevi_cluster,
                     median_iqr = paste0(median_nevi,' (',iqr,')'))
  return(tab_summary)
}
# Generate summary stats
stab5 <- zip_final %>% 
  janitor::tabyl(nevi_cluster) %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  dplyr::transmute(nevi_cluster = nevi_cluster,
                   n_percent = paste0('(n = ', n,', ', percent,')')) %>% 
  dplyr::left_join(gen_stab5(zip_final, 'nevi') %>% dplyr::rename(nvi_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_age') %>% dplyr::rename(score_demo_age_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_femaleled') %>% dplyr::rename(score_demo_femaleled_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_immigration') %>% dplyr::rename(score_demo_immigration_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_disability') %>% dplyr::rename(score_demo_disability_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_singleparent') %>% dplyr::rename(score_demo_singleparent_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_mobility') %>% dplyr::rename(score_demo_mobility_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_livealone') %>% dplyr::rename(score_demo_livealone_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_incomepoverty') %>% dplyr::rename(score_economic_incomepoverty_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_servicemanual') %>% dplyr::rename(score_economic_servicemanual_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_gini') %>% dplyr::rename(score_economic_gini_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_employment') %>% dplyr::rename(score_economic_employment_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_education') %>% dplyr::rename(score_economic_education_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_vehicleavail') %>% dplyr::rename(score_economic_vehicleavail_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_popdensity') %>% dplyr::rename(score_residential_popdensity_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_groupquarters') %>% dplyr::rename(score_residential_groupquarters_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_occperroom') %>% dplyr::rename(score_residential_occperroom_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structage') %>% dplyr::rename(score_residential_structage_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structattach') %>% dplyr::rename(score_residential_structattach_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_move1yr') %>% dplyr::rename(score_residential_move1yr_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_vacancy') %>% dplyr::rename(score_residential_vacancy_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lifestyle') %>% dplyr::rename(score_healthstatus_lifestyle_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_condition') %>% dplyr::rename(score_healthstatus_condition_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_preventive') %>% dplyr::rename(score_healthstatus_preventive_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lackinsurance') %>% dplyr::rename(score_healthstatus_lackinsurance_median_iqr = median_iqr)) %>% 
  t()
fig5_df <- stab5 %>% 
  dplyr::as_tibble(rownames = 'subdomain') %>% 
  dplyr::filter(!row_number() %in% c(1,2,3)) %>% 
  dplyr::transmute(subdomain = subdomain,
                   cluster1 = str_sub(V1, 1L, 4L) %>% as.numeric,
                   cluster2 = str_sub(V2, 1L, 4L) %>% as.numeric,
                   cluster3 = str_sub(V3, 1L, 4L) %>% as.numeric,
                   #cluster4 = str_sub(V4, 1L, 4L) %>% as.numeric,
                   #cluster5 = str_sub(V5, 1L, 4L) %>% as.numeric,
                   #cluster6 = str_sub(V6, 1L, 4L) %>% as.numeric,
                   subdomain_label = case_when(
                     subdomain == 'score_demo_age_median_iqr' ~ subdomain_label_vector[1],
                     subdomain == 'score_demo_femaleled_median_iqr' ~ subdomain_label_vector[2],
                     subdomain == 'score_demo_immigration_median_iqr' ~ subdomain_label_vector[3],
                     subdomain == 'score_demo_disability_median_iqr' ~ subdomain_label_vector[4],
                     subdomain == 'score_demo_singleparent_median_iqr' ~ subdomain_label_vector[5],
                     subdomain == 'score_demo_mobility_median_iqr' ~ subdomain_label_vector[6],
                     subdomain == 'score_demo_livealone_median_iqr' ~ subdomain_label_vector[7],
                     subdomain == 'score_economic_incomepoverty_median_iqr' ~ subdomain_label_vector[8],
                     subdomain == 'score_economic_servicemanual_median_iqr' ~ subdomain_label_vector[9],
                     subdomain == 'score_economic_gini_median_iqr' ~ subdomain_label_vector[10],
                     subdomain == 'score_economic_employment_median_iqr' ~ subdomain_label_vector[11],
                     subdomain == 'score_economic_education_median_iqr' ~ subdomain_label_vector[12],
                     subdomain == 'score_economic_vehicleavail_median_iqr' ~ subdomain_label_vector[13],
                     subdomain == 'score_residential_popdensity_median_iqr' ~ subdomain_label_vector[14],
                     subdomain == 'score_residential_groupquarters_median_iqr' ~ subdomain_label_vector[15],
                     subdomain == 'score_residential_occperroom_median_iqr' ~ subdomain_label_vector[16],
                     subdomain == 'score_residential_structage_median_iqr' ~ subdomain_label_vector[17],
                     subdomain == 'score_residential_structattach_median_iqr' ~ subdomain_label_vector[18],
                     subdomain == 'score_residential_move1yr_median_iqr' ~ subdomain_label_vector[19],
                     subdomain == 'score_residential_vacancy_median_iqr' ~ subdomain_label_vector[20],
                     subdomain == 'score_healthstatus_lifestyle_median_iqr' ~ subdomain_label_vector[21],
                     subdomain == 'score_healthstatus_condition_median_iqr' ~ subdomain_label_vector[22],
                     subdomain == 'score_healthstatus_preventive_median_iqr' ~ subdomain_label_vector[23],
                     subdomain == 'score_healthstatus_lackinsurance_median_iqr' ~ subdomain_label_vector[24]
                   ) %>% factor(levels = subdomain_label_vector, ordered = TRUE), 
                   domain = case_when(
                     stringr::str_detect(subdomain, 'demo') ~ domain_label_vector[1],
                     stringr::str_detect(subdomain, 'economic') ~ domain_label_vector[2],
                     stringr::str_detect(subdomain, 'residential') ~ domain_label_vector[3],
                     stringr::str_detect(subdomain, 'healthstatus') ~ domain_label_vector[4]
                   ) %>% factor(levels = domain_label_vector, ordered = TRUE)) %>%  
  dplyr::select(-subdomain) %>% 
  tidyr::pivot_longer(cols = starts_with('cluster'), names_to = 'cluster', names_prefix = 'cluster', values_to = 'median') %>% 
  # dplyr::mutate(cluster_label = case_when(
  #  cluster == '1' ~ '1\n(n = 435)',
  #  cluster == '2' ~ '2\n(n = 331)',
  #  cluster == '3' ~ '3\n(n = 903)',
  #  cluster == '4' ~ '4\n(n = 5)',
  #  cluster == '5' ~ '5\n(n = 241)',
  #  cluster == '6' ~ '6\n(n = 171)'
  #)) %>% 
  dplyr::group_by(subdomain_label) %>% 
  dplyr::mutate(median_scaled = scale(median))

##### CREATE: heatmap 
ggplot(data = fig5_df, aes(x = cluster, y = subdomain_label, fill = median_scaled)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'Cluster', y = 'Subdomain', fill = "Median Score (Scaled)") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', color = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))
## EXPORT
#ggsave('figs/fig5.png', width = 10, height = 13)


```



# 4 CLUSTERS
## FIGURE 4 IN MS - PART B (CLUSTER MAP + CLUSTER PROFILE)
```{r}
## CREATE: PART 1 - CLUSTER PROFILES
# Colors
# Explore color options
  # colorBlindness::displayAllColors(paletteMartin, color="white")
  # colors_colorblindsafe <- paletteMartin[c(5, 6, 9, 11, 14, 15)] %>% unname()
colors_colorblindsafe <- c('#ffff6d','#6db6ff','#ffb6db','#24ff24','#920000','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nevi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
fig4b_part1_df <- zip_final %>% 
  dplyr::group_by(nevi_cluster4) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nevi = mean(nevi),
                   q1_nevi = quantile(nevi, 0.25),
                   q3_nevi = quantile(nevi, 0.75),
                   iqr_nevi = paste0(round(q1_nevi, 2), "-", round(q3_nevi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nevi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nevi_cat = case_when(nevi_cat_prelim == 'mean_demo_score'         ~ nevi_cat_levels[1],
                                     nevi_cat_prelim == 'mean_economic_score'     ~ nevi_cat_levels[2],
                                     nevi_cat_prelim == 'mean_residential_score'  ~ nevi_cat_levels[3],
                                     nevi_cat_prelim == 'mean_healthstatus_score' ~ nevi_cat_levels[4]) %>% factor(nevi_cat_levels),
                nevi_cluster_label = paste0("Cluster ", nevi_cluster4, " (n = ", n_obs, ",\nMean NVI = ", round(mean_nevi,2), ")"))
# Plotting
fig4b_part1_prelim <- ggplot(fig4b_part1_df, aes(x = nevi_cat, y = mean, fill = nevi_cluster_label, pattern = nevi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") +
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nevi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
fig4b_part1_plot_build <- ggplot_build(fig4b_part1_prelim)
for(i in 1:4){
  fig4b_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
fig4b_part1 <- ggplot_gtable(fig4b_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_fig4b_part2 <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
fig4b_part2 <- gen_fig4b_part2(dfin = zip_final_spatial, dfexcl = zip_exclude_spatial, fill_var = "nevi_cluster4", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Environmental Vulnerability Index Cluster") 

## COMBINED PLOT
fig4b <- ggarrange(fig4b_part1, ggarrange(fig4b_part2, ggplot() + theme_void(), ncol = 2), nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
fig4b
# EXPORT
#ggsave('figs/fig4_partb_zip.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12

```
### FIGURE 5 IN MS (HEATMAP)
```{r}
### CREATE: Heat maps to visualize clustering by subdomain
## PREPARE DATA
subdomain_label_vector <- c(
  'Age','Female-Led Households','Immigration','Disability','Single Parent Households','Transportation','Single Households',
  'Income and Poverty','Occupation','Income Inequality','Employment Status','Education','Vehicle Availability',
  'Population Density','Group Quarters','Household Density','Age of Housing Structure','Units in Housing Structure','Residential Mobility','Vacancy',
  'Health Behaviors','Health Conditions','Prevention Practices','Health Insurance Status'
)
domain_label_vector <- c('Demographic\n Domain', 'Economic Indicators\n Domain', 'Residential\n Domain', 'Health Status\n Domain')
gen_stab5 <- function(dfin, var){
  var <- sym(var)
  var_median <- sym(paste0('median_iqr_', var))
  nevi_cluster_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster4) %>% 
    dplyr::summarize(iqr_prelim = quantile(!!var, c(0.25, 0.75)) %>% round(2) %>% format(2)) %>% 
    dplyr::group_by(nevi_cluster4) %>% 
    dplyr::summarize(iqr = paste(iqr_prelim, collapse = '-'))
  tab_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster4) %>%
    dplyr::summarize(median_nevi = median(!!var) %>% round(2) %>% format(nsmall = 2)) %>% 
    dplyr::left_join(nevi_cluster_summary, by = 'nevi_cluster4') %>% 
    dplyr::summarize(nevi_cluster4 = nevi_cluster4,
                     median_iqr = paste0(median_nevi,' (',iqr,')'))
  return(tab_summary)
}
# Generate summary stats
stab5 <- zip_final %>% 
  janitor::tabyl(nevi_cluster4) %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  dplyr::transmute(nevi_cluster4 = nevi_cluster4,
                   n_percent = paste0('(n = ', n,', ', percent,')')) %>% 
  dplyr::left_join(gen_stab5(zip_final, 'nevi') %>% dplyr::rename(nvi_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_age') %>% dplyr::rename(score_demo_age_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_femaleled') %>% dplyr::rename(score_demo_femaleled_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_immigration') %>% dplyr::rename(score_demo_immigration_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_disability') %>% dplyr::rename(score_demo_disability_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_singleparent') %>% dplyr::rename(score_demo_singleparent_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_mobility') %>% dplyr::rename(score_demo_mobility_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_livealone') %>% dplyr::rename(score_demo_livealone_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_incomepoverty') %>% dplyr::rename(score_economic_incomepoverty_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_servicemanual') %>% dplyr::rename(score_economic_servicemanual_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_gini') %>% dplyr::rename(score_economic_gini_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_employment') %>% dplyr::rename(score_economic_employment_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_education') %>% dplyr::rename(score_economic_education_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_vehicleavail') %>% dplyr::rename(score_economic_vehicleavail_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_popdensity') %>% dplyr::rename(score_residential_popdensity_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_groupquarters') %>% dplyr::rename(score_residential_groupquarters_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_occperroom') %>% dplyr::rename(score_residential_occperroom_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structage') %>% dplyr::rename(score_residential_structage_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structattach') %>% dplyr::rename(score_residential_structattach_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_move1yr') %>% dplyr::rename(score_residential_move1yr_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_vacancy') %>% dplyr::rename(score_residential_vacancy_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lifestyle') %>% dplyr::rename(score_healthstatus_lifestyle_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_condition') %>% dplyr::rename(score_healthstatus_condition_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_preventive') %>% dplyr::rename(score_healthstatus_preventive_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lackinsurance') %>% dplyr::rename(score_healthstatus_lackinsurance_median_iqr = median_iqr)) %>% 
  t()
fig5_df <- stab5 %>% 
  dplyr::as_tibble(rownames = 'subdomain') %>% 
  dplyr::filter(!row_number() %in% c(1,2,3)) %>% 
  dplyr::transmute(subdomain = subdomain,
                   cluster1a = str_sub(V1, 1L, 4L) %>% as.numeric,
                   cluster1b = str_sub(V2, 1L, 4L) %>% as.numeric,
                   cluster2 = str_sub(V3, 1L, 4L) %>% as.numeric,
                   cluster3 = str_sub(V4, 1L, 4L) %>% as.numeric,
                   #cluster5 = str_sub(V5, 1L, 4L) %>% as.numeric,
                   #cluster6 = str_sub(V6, 1L, 4L) %>% as.numeric,
                   subdomain_label = case_when(
                     subdomain == 'score_demo_age_median_iqr' ~ subdomain_label_vector[1],
                     subdomain == 'score_demo_femaleled_median_iqr' ~ subdomain_label_vector[2],
                     subdomain == 'score_demo_immigration_median_iqr' ~ subdomain_label_vector[3],
                     subdomain == 'score_demo_disability_median_iqr' ~ subdomain_label_vector[4],
                     subdomain == 'score_demo_singleparent_median_iqr' ~ subdomain_label_vector[5],
                     subdomain == 'score_demo_mobility_median_iqr' ~ subdomain_label_vector[6],
                     subdomain == 'score_demo_livealone_median_iqr' ~ subdomain_label_vector[7],
                     subdomain == 'score_economic_incomepoverty_median_iqr' ~ subdomain_label_vector[8],
                     subdomain == 'score_economic_servicemanual_median_iqr' ~ subdomain_label_vector[9],
                     subdomain == 'score_economic_gini_median_iqr' ~ subdomain_label_vector[10],
                     subdomain == 'score_economic_employment_median_iqr' ~ subdomain_label_vector[11],
                     subdomain == 'score_economic_education_median_iqr' ~ subdomain_label_vector[12],
                     subdomain == 'score_economic_vehicleavail_median_iqr' ~ subdomain_label_vector[13],
                     subdomain == 'score_residential_popdensity_median_iqr' ~ subdomain_label_vector[14],
                     subdomain == 'score_residential_groupquarters_median_iqr' ~ subdomain_label_vector[15],
                     subdomain == 'score_residential_occperroom_median_iqr' ~ subdomain_label_vector[16],
                     subdomain == 'score_residential_structage_median_iqr' ~ subdomain_label_vector[17],
                     subdomain == 'score_residential_structattach_median_iqr' ~ subdomain_label_vector[18],
                     subdomain == 'score_residential_move1yr_median_iqr' ~ subdomain_label_vector[19],
                     subdomain == 'score_residential_vacancy_median_iqr' ~ subdomain_label_vector[20],
                     subdomain == 'score_healthstatus_lifestyle_median_iqr' ~ subdomain_label_vector[21],
                     subdomain == 'score_healthstatus_condition_median_iqr' ~ subdomain_label_vector[22],
                     subdomain == 'score_healthstatus_preventive_median_iqr' ~ subdomain_label_vector[23],
                     subdomain == 'score_healthstatus_lackinsurance_median_iqr' ~ subdomain_label_vector[24]
                   ) %>% factor(levels = subdomain_label_vector, ordered = TRUE), 
                   domain = case_when(
                     stringr::str_detect(subdomain, 'demo') ~ domain_label_vector[1],
                     stringr::str_detect(subdomain, 'economic') ~ domain_label_vector[2],
                     stringr::str_detect(subdomain, 'residential') ~ domain_label_vector[3],
                     stringr::str_detect(subdomain, 'healthstatus') ~ domain_label_vector[4]
                   ) %>% factor(levels = domain_label_vector, ordered = TRUE)) %>%  
  dplyr::select(-subdomain) %>% 
  tidyr::pivot_longer(cols = starts_with('cluster'), names_to = 'cluster', names_prefix = 'cluster', values_to = 'median') %>% 
  # dplyr::mutate(cluster_label = case_when(
  #  cluster == '1' ~ '1\n(n = 435)',
  #  cluster == '2' ~ '2\n(n = 331)',
  #  cluster == '3' ~ '3\n(n = 903)',
  #  cluster == '4' ~ '4\n(n = 5)',
  #  cluster == '5' ~ '5\n(n = 241)',
  #  cluster == '6' ~ '6\n(n = 171)'
  #)) %>% 
  dplyr::group_by(subdomain_label) %>% 
  dplyr::mutate(median_scaled = scale(median))

##### CREATE: heatmap 
ggplot(data = fig5_df, aes(x = cluster, y = subdomain_label, fill = median_scaled)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'Cluster', y = 'Subdomain', fill = "Median Score (Scaled)") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', color = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))
## EXPORT
#ggsave('figs/fig5.png', width = 10, height = 13)


```


# 5 CLUSTERS
## FIGURE 4 IN MS - PART B (CLUSTER MAP + CLUSTER PROFILE)
```{r}
## CREATE: PART 1 - CLUSTER PROFILES
# Colors
# Explore color options
  # colorBlindness::displayAllColors(paletteMartin, color="white")
  # colors_colorblindsafe <- paletteMartin[c(5, 6, 9, 11, 14, 15)] %>% unname()
colors_colorblindsafe <- c('#ffff6d','#6db6ff','#ffb6db','#920000','#24ff24','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nevi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
fig4b_part1_df <- zip_final %>% 
  dplyr::group_by(nevi_cluster5) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nevi = mean(nevi),
                   q1_nevi = quantile(nevi, 0.25),
                   q3_nevi = quantile(nevi, 0.75),
                   iqr_nevi = paste0(round(q1_nevi, 2), "-", round(q3_nevi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nevi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nevi_cat = case_when(nevi_cat_prelim == 'mean_demo_score'         ~ nevi_cat_levels[1],
                                     nevi_cat_prelim == 'mean_economic_score'     ~ nevi_cat_levels[2],
                                     nevi_cat_prelim == 'mean_residential_score'  ~ nevi_cat_levels[3],
                                     nevi_cat_prelim == 'mean_healthstatus_score' ~ nevi_cat_levels[4]) %>% factor(nevi_cat_levels),
                nevi_cluster_label = paste0("Cluster ", nevi_cluster5, " (n = ", n_obs, ",\nMean NVI = ", round(mean_nevi,2), ")"))
# Plotting
fig4b_part1_prelim <- ggplot(fig4b_part1_df, aes(x = nevi_cat, y = mean, fill = nevi_cluster_label, pattern = nevi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") +
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nevi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
fig4b_part1_plot_build <- ggplot_build(fig4b_part1_prelim)
for(i in 1:3){
  fig4b_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
fig4b_part1 <- ggplot_gtable(fig4b_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_fig4b_part2 <- function(dfin, dfexcl, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
fig4b_part2 <- gen_fig4b_part2(dfin = zip_final_spatial, dfexcl = zip_exclude_spatial, fill_var = "nevi_cluster5", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Environmental Vulnerability Index Cluster") 

## COMBINED PLOT
fig4b <- ggarrange(fig4b_part1, ggarrange(fig4b_part2, ggplot() + theme_void(), ncol = 2), nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
fig4b
# EXPORT
#ggsave('figs/fig4_partb_zip.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12

```
### FIGURE 5 IN MS (HEATMAP)
```{r}
### CREATE: Heat maps to visualize clustering by subdomain
## PREPARE DATA
subdomain_label_vector <- c(
  'Age','Female-Led Households','Immigration','Disability','Single Parent Households','Transportation','Single Households',
  'Income and Poverty','Occupation','Income Inequality','Employment Status','Education','Vehicle Availability',
  'Population Density','Group Quarters','Household Density','Age of Housing Structure','Units in Housing Structure','Residential Mobility','Vacancy',
  'Health Behaviors','Health Conditions','Prevention Practices','Health Insurance Status'
)
domain_label_vector <- c('Demographic\n Domain', 'Economic Indicators\n Domain', 'Residential\n Domain', 'Health Status\n Domain')
gen_stab5 <- function(dfin, var){
  var <- sym(var)
  var_median <- sym(paste0('median_iqr_', var))
  nevi_cluster_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster5) %>% 
    dplyr::summarize(iqr_prelim = quantile(!!var, c(0.25, 0.75)) %>% round(2) %>% format(2)) %>% 
    dplyr::group_by(nevi_cluster5) %>% 
    dplyr::summarize(iqr = paste(iqr_prelim, collapse = '-'))
  tab_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster5) %>%
    dplyr::summarize(median_nevi = median(!!var) %>% round(2) %>% format(nsmall = 2)) %>% 
    dplyr::left_join(nevi_cluster_summary, by = 'nevi_cluster5') %>% 
    dplyr::summarize(nevi_cluster5 = nevi_cluster5,
                     median_iqr = paste0(median_nevi,' (',iqr,')'))
  return(tab_summary)
}
# Generate summary stats
stab5 <- zip_final %>% 
  janitor::tabyl(nevi_cluster5) %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  dplyr::transmute(nevi_cluster5 = nevi_cluster5,
                   n_percent = paste0('(n = ', n,', ', percent,')')) %>% 
  dplyr::left_join(gen_stab5(zip_final, 'nevi') %>% dplyr::rename(nvi_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_age') %>% dplyr::rename(score_demo_age_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_femaleled') %>% dplyr::rename(score_demo_femaleled_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_immigration') %>% dplyr::rename(score_demo_immigration_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_disability') %>% dplyr::rename(score_demo_disability_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_singleparent') %>% dplyr::rename(score_demo_singleparent_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_mobility') %>% dplyr::rename(score_demo_mobility_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_demo_livealone') %>% dplyr::rename(score_demo_livealone_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_incomepoverty') %>% dplyr::rename(score_economic_incomepoverty_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_servicemanual') %>% dplyr::rename(score_economic_servicemanual_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_gini') %>% dplyr::rename(score_economic_gini_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_employment') %>% dplyr::rename(score_economic_employment_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_education') %>% dplyr::rename(score_economic_education_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_economic_vehicleavail') %>% dplyr::rename(score_economic_vehicleavail_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_popdensity') %>% dplyr::rename(score_residential_popdensity_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_groupquarters') %>% dplyr::rename(score_residential_groupquarters_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_occperroom') %>% dplyr::rename(score_residential_occperroom_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structage') %>% dplyr::rename(score_residential_structage_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_structattach') %>% dplyr::rename(score_residential_structattach_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_move1yr') %>% dplyr::rename(score_residential_move1yr_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_residential_vacancy') %>% dplyr::rename(score_residential_vacancy_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lifestyle') %>% dplyr::rename(score_healthstatus_lifestyle_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_condition') %>% dplyr::rename(score_healthstatus_condition_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_preventive') %>% dplyr::rename(score_healthstatus_preventive_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab5(zip_final, 'score_healthstatus_lackinsurance') %>% dplyr::rename(score_healthstatus_lackinsurance_median_iqr = median_iqr)) %>% 
  t()
fig5_df <- stab5 %>% 
  dplyr::as_tibble(rownames = 'subdomain') %>% 
  dplyr::filter(!row_number() %in% c(1,2,3)) %>% 
  dplyr::transmute(subdomain = subdomain,
                   cluster1a = str_sub(V1, 1L, 4L) %>% as.numeric,
                   cluster1b = str_sub(V2, 1L, 4L) %>% as.numeric,
                   cluster2a = str_sub(V3, 1L, 4L) %>% as.numeric,
                   cluster2b = str_sub(V4, 1L, 4L) %>% as.numeric,
                   cluster3 = str_sub(V5, 1L, 4L) %>% as.numeric,
                   #cluster6 = str_sub(V6, 1L, 4L) %>% as.numeric,
                   subdomain_label = case_when(
                     subdomain == 'score_demo_age_median_iqr' ~ subdomain_label_vector[1],
                     subdomain == 'score_demo_femaleled_median_iqr' ~ subdomain_label_vector[2],
                     subdomain == 'score_demo_immigration_median_iqr' ~ subdomain_label_vector[3],
                     subdomain == 'score_demo_disability_median_iqr' ~ subdomain_label_vector[4],
                     subdomain == 'score_demo_singleparent_median_iqr' ~ subdomain_label_vector[5],
                     subdomain == 'score_demo_mobility_median_iqr' ~ subdomain_label_vector[6],
                     subdomain == 'score_demo_livealone_median_iqr' ~ subdomain_label_vector[7],
                     subdomain == 'score_economic_incomepoverty_median_iqr' ~ subdomain_label_vector[8],
                     subdomain == 'score_economic_servicemanual_median_iqr' ~ subdomain_label_vector[9],
                     subdomain == 'score_economic_gini_median_iqr' ~ subdomain_label_vector[10],
                     subdomain == 'score_economic_employment_median_iqr' ~ subdomain_label_vector[11],
                     subdomain == 'score_economic_education_median_iqr' ~ subdomain_label_vector[12],
                     subdomain == 'score_economic_vehicleavail_median_iqr' ~ subdomain_label_vector[13],
                     subdomain == 'score_residential_popdensity_median_iqr' ~ subdomain_label_vector[14],
                     subdomain == 'score_residential_groupquarters_median_iqr' ~ subdomain_label_vector[15],
                     subdomain == 'score_residential_occperroom_median_iqr' ~ subdomain_label_vector[16],
                     subdomain == 'score_residential_structage_median_iqr' ~ subdomain_label_vector[17],
                     subdomain == 'score_residential_structattach_median_iqr' ~ subdomain_label_vector[18],
                     subdomain == 'score_residential_move1yr_median_iqr' ~ subdomain_label_vector[19],
                     subdomain == 'score_residential_vacancy_median_iqr' ~ subdomain_label_vector[20],
                     subdomain == 'score_healthstatus_lifestyle_median_iqr' ~ subdomain_label_vector[21],
                     subdomain == 'score_healthstatus_condition_median_iqr' ~ subdomain_label_vector[22],
                     subdomain == 'score_healthstatus_preventive_median_iqr' ~ subdomain_label_vector[23],
                     subdomain == 'score_healthstatus_lackinsurance_median_iqr' ~ subdomain_label_vector[24]
                   ) %>% factor(levels = subdomain_label_vector, ordered = TRUE), 
                   domain = case_when(
                     stringr::str_detect(subdomain, 'demo') ~ domain_label_vector[1],
                     stringr::str_detect(subdomain, 'economic') ~ domain_label_vector[2],
                     stringr::str_detect(subdomain, 'residential') ~ domain_label_vector[3],
                     stringr::str_detect(subdomain, 'healthstatus') ~ domain_label_vector[4]
                   ) %>% factor(levels = domain_label_vector, ordered = TRUE)) %>%  
  dplyr::select(-subdomain) %>% 
  tidyr::pivot_longer(cols = starts_with('cluster'), names_to = 'cluster', names_prefix = 'cluster', values_to = 'median') %>% 
  # dplyr::mutate(cluster_label = case_when(
  #  cluster == '1' ~ '1\n(n = 435)',
  #  cluster == '2' ~ '2\n(n = 331)',
  #  cluster == '3' ~ '3\n(n = 903)',
  #  cluster == '4' ~ '4\n(n = 5)',
  #  cluster == '5' ~ '5\n(n = 241)',
  #  cluster == '6' ~ '6\n(n = 171)'
  #)) %>% 
  dplyr::group_by(subdomain_label) %>% 
  dplyr::mutate(median_scaled = scale(median))

##### CREATE: heatmap 
ggplot(data = fig5_df, aes(x = cluster, y = subdomain_label, fill = median_scaled)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'Cluster', y = 'Subdomain', fill = "Median Score (Scaled)") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', color = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))
## EXPORT
#ggsave('figs/fig5.png', width = 10, height = 13)


```
