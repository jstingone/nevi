---
title: "Neighborhood Environmental Vulnerability Index, 2019: Create Figures and Tables"
author: 
- "Stephen P. Uong; Contributors: Jiayi Zhou, Jeanette A. Stingone"
date: "3/29/2022"
output: rmarkdown::github_document
---

Below is coded we used to generate results and figures that we used to evaluate the NEVI and to comapre the NEVI to the Neighborhood Deprivation Index (NDI)/ Social Vulnerability Index (SVI).

## 1. Setup, Data Import, and Data Cleaning

### 1.1. Set Working Directory

Set the working directory to one folder up from the RMarkdown file for later data export.

```{r, setup}
knitr::opts_knit$set(root.dir = '..') 
```

### 1.2. Load Required Libraries

Load the following required libraries.

```{r, libraries}
library(tidyverse)
library(rio)
library(factoextra)
library(cluster)
library(skimr)
# Tables
library(janitor)
library(gtsummary)
# Mapping
library(sf)
library(ggpubr)
library(ggsn)
library(ggspatial)
library(nycgeo)
library(tigris)
library(ggsflabel) # Ref: https://yutannihilation.github.io/ggsflabel/index.html
# Plots
library(ggpubr)
library(colorBlindness)
library(ggpattern) # Ref: https://coolbutuseless.github.io/package/ggpattern/index.html
library(gplots) # heat map
```

### 1.3: Import the NEVI, NDI, and SVI

```{r}
setwd('C:/Users/steph/OneDrive - cumc.columbia.edu/Phi/My Courses/Columbia/Work/Research - Jeanette/projects/covid-vulnerability-index/comms/git nvi')

### IMPORT: Cleaned NEVI data with the NEVI, NEVI features, and NEVI clusters
tract_final <- readRDS(file = "data/processed/nevi_tract_final.rds")

### IMPORT: NYC borough for each tract
tract_nyc_borough <- nycgeo::nyc_boundaries(geography = "tract") %>% 
  dplyr::as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  dplyr::transmute(Tract_FIPS = geoid,
                   borough = borough_name)

### IMPORT: NDI, SVI
ndi <- import("data/processed/other indices/Neighborhood Deprivation Index/ndi_tract.csv")
svi <- import("data/processed/other indices/Social Vulnerability Index/svi.csv")

ndi_clean <- ndi %>% dplyr::mutate(Tract_FIPS = GEOID %>% as.character() %>% str_pad(11,side="left",pad="0")) %>% dplyr::rename(ndi = NDI_score) %>% dplyr::select(Tract_FIPS, ndi) %>% 
  dplyr::left_join(tract_nyc_borough, by = "Tract_FIPS")
svi_clean <- svi %>% dplyr::mutate(Tract_FIPS = FIPS %>% as.character() %>% str_pad(11,side="left",pad="0")) %>% dplyr::rename(svi = RPL_THEMES) %>% dplyr::select(Tract_FIPS, svi) %>% 
  dplyr::filter(svi != -999) %>% 
  dplyr::left_join(tract_nyc_borough, by = "Tract_FIPS") %>% 
  dplyr::inner_join(tract_final %>% dplyr::select(Tract_FIPS), by = "Tract_FIPS")

## IMPORT: Race/ethnicity sensitivity analysis
tract_toxpi_pre_raceeth_no_olap <- import('data/processed/sensitivity analysis/race and ethnicity/toxpi/results/nevi_toxpi_raceeth_no_olap_results.csv')
tract_toxpi_pre_raceeth_olap <- import('data/processed/sensitivity analysis/race and ethnicity/toxpi/results/nevi_toxpi_raceeth_olap_results.csv')
tract_toxpi_pre_raceeth_hsub <- import('data/processed/sensitivity analysis/race and ethnicity/toxpi/results/nevi_toxpi_raceeth_hsub_results.csv')
```

### 1.5. Create spatial objects

```{r}
### IMPORT: NYC specific Census tract/borough boundaries
tract_nyc_spatial <- nycgeo::nyc_boundaries(geography = "tract") %>% 
  dplyr::transmute(Tract_FIPS = geoid) %>% 
  sf::st_transform(crs = 2263)
borough_nyc_spatial <- nycgeo::nyc_boundaries(geography = "borough") %>%
  dplyr::arrange(borough_name) %>% 
  sf::st_transform(crs = 2263)
# Spatial: crs = "+init=epsg:2263"
  # Included
tract_final_spatial <- tract_nyc_spatial %>% 
  dplyr::inner_join(tract_final %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS") # Checked: did not exclude any tracts, 8/11
  # Excluded
tract_exclude_spatial <- tract_nyc_spatial %>% 
  dplyr::anti_join(tract_final %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS") 
```

## 2. Figures

### 2.1. Figure 1: NEVI and Domains

```{r mapping, include=FALSE}
#### CREATE: Functions to create maps
gen_fig1_main <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label, lab_borough){
  plot_choro <- ggplot() + 
    # tracts
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    # tracts, excluded
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    theme_minimal() + # Alt: ggthemes::theme_map()
        # boroughs
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    geom_sf_label_repel(data = dfborough, aes(label = !!sym(lab_borough)), force = 0, nudge_x = c(40000, -45000, -30000, 30000, 35000), nudge_y = c(20000, 20000, 10000, -50000, -20000), seed = 1, size = 6) +
    ggspatial::annotation_north_arrow(location = 'tl', height = unit(1.3,'cm'), width = unit(1.5, 'cm'), pad_x = unit(1.5, "cm"), pad_y = unit(1.5, "cm"), style = north_arrow_orienteering(fill = c('black','black'), text_size = 11)) +
    ggsn::scalebar(data = dfborough, dist = 10, dist_unit = "mi", height = 0.01, st.size = 5, st.dist = 0.05, transform = FALSE, model = 'WGS84', location = "bottomright") +
        # Alt: ggsn::north(data = dfborough, location = "topleft", symbol = 10, scale = 0.10) + # use the ggspatial package in order to export to .eps properly
        # Alt: ggspatial::annotation_scale(plot_unit = "mi", location = 'br') + #bgcolor("lightcyan") + #snow2 #plot_unit = "mi", pad_x = unit(7.5, "cm"), pad_y = unit(-1, "cm")
    labs(fill = fill_label) + 
    scale_fill_gradient(low = "whitesmoke", high = fill_color) + # na.value = "gray30"
    theme(legend.title = element_text(face = "bold", size = 15), # plot.title = element_text(hjust = 0.75, face = "bold", size = 15),
          legend.text = element_text(size = 12),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "right",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank()) # plot.caption = element_text(hjust = 0, size = 10, face = "italic"), legend.position = c(1,0.5), plot.background = element_rect(fill = "lightcyan")
  return(plot_choro)
}
gen_fig1_part <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label, fill_label_just, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    theme_minimal() + 
    scale_fill_gradient(low = "whitesmoke", high = fill_color, breaks = seq(0, 1, fill_increment)) + 
    labs(fill = fill_label) + 
    theme(legend.title = element_text(face = "bold", size = 14, vjust = fill_label_just),  # vertically center legend with its label - does not work well
          legend.text = element_text(size = 10),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "right",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank())
  return(plot_choro)
}



### CREATE: Maps
  # Overall Index
fig1_toxpi <- gen_fig1_main(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "nevi", fill_color = '#954100',
fill_label = "Neighborhood\nEnvironmental\nVulnerability Index", lab_borough = 'borough_name')
  # Domain Scores
fig1_demo <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "score_demo", fill_color = '#004F7C', fill_label = "Demographics Score", fill_label_just = 0.5, fill_increment = 0.1)
fig1_econ <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial,fill_var = "score_economic", fill_color = '#006E50', fill_label = "Economic\nIndicators Score", fill_label_just = 0.5, fill_increment = 0.2)
fig1_resd <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial,fill_var = "score_residential", fill_color = '#A16F00', fill_label = "Residential Density\nand Characteristics\nScore", fill_label_just = 4, fill_increment = 0.2)
fig1_hlth <- gen_fig1_part(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial,fill_var = "score_healthstatus", fill_color = '#8E5474', fill_label = "Health Behavior,\nOutcomes,\nPrevention Practices,\nand Access Score", fill_label_just = 4, fill_increment = 0.2)
## MERGE: Maps
  # Alt: gridExtra::grid.arrange(fig1_toxpi, fig1_demo, fig1_econ, fig1_resd, fig1_hlth, ncol = 4, nrow = 2, layout_matrix = rbind(c(1,1,2,3), c(1,1,4,5))) 
  # Ref: https://www.datanovia.com/en/lessons/combine-multiple-ggplots-into-a-figure/
fig1_part1 <- ggarrange(fig1_toxpi, fig1_demo, nrow = 2, labels = c("A","B"), align = "v", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))
fig1_part2 <- ggarrange(fig1_econ, fig1_resd, nrow = 2, labels = c("C","D"), align = "v", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))
fig1_part3 <- ggarrange(fig1_hlth, labels = "E", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 1, l = 0, "cm"))

## EXPORT
fig1_part1
ggsave('figures and tables/figures/fig1_part1.png', width = 10, height = 15) # pixels: 1200 x 900, width = 15, height = 12
ggsave('figures and tables/figures/eps/fig1_part1.eps', width = 10, height = 15)
fig1_part2
ggsave('figures and tables/figures/fig1_part2.png', width = 10, height = 15) 
ggsave('figures and tables/figures/eps/fig1_part2.eps', width = 10, height = 15) 
fig1_part3
ggsave('figures and tables/figures/fig1_part3.png', width = 10, height = 8) 
ggsave('figures and tables/figures/eps/fig1_part3.eps', width = 10, height = 8) 

```

### 2.2. Figure 2. Map - NEVI, NDI, SVI

```{r}
#### CREATE: Functions to create maps
gen_fig2_main <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    theme_minimal() + # Alt: ggthemes::theme_map()
    ggspatial::annotation_north_arrow(location = 'br', height = unit(1,'cm'), width = unit(1.1, 'cm'), pad_x = unit(1.5, "cm"), pad_y = unit(0.5, "cm"), style = north_arrow_orienteering(fill = c('black','black'), text_size = 11)) +
    ggsn::scalebar(data = dfin, dist = 20, dist_unit = "mi", height = 0.01, st.size = 5, st.dist = 0.05, transform = FALSE, model = 'WGS84', location = "topleft") +
        # Alt: ggsn::north(data = dfborough, location = "topleft", symbol = 10, scale = 0.10) + # use the ggspatial package in order to export to .eps properly
        # Alt: ggspatial::annotation_scale(plot_unit = "mi", location = 'br') + #bgcolor("lightcyan") + #snow2 #plot_unit = "mi", pad_x = unit(7.5, "cm"), pad_y = unit(-1, "cm")
    labs(fill = fill_label) + 
    #scale_fill_gradient(low = "whitesmoke", high = fill_color) + # na.value = "gray30"
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) + # cannot seem to get title to center: title.hjust = 0.5
    theme(legend.title = element_text(face = "bold", size = 15), # plot.title = element_text(hjust = 0.75, face = "bold", size = 15),
          legend.text = element_text(size = 12),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "bottom",
          legend.box = "vertical",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank())  # plot.caption = element_text(hjust = 0, size = 10, face = "italic"), legend.position = c(1,0.5), plot.background = element_rect(fill = "lightcyan")
    #guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  return(plot_choro)
}
gen_fig2_part <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label, fill_label_just, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray30", fill = "gray30") + 
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    theme(legend.title = element_text(face = "bold", size = 14, vjust = fill_label_just),  # vertically center legend with its label - does not work well
          legend.text = element_text(size = 10),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.position = "bottom",
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank()) 
  return(plot_choro)
}

### PREP DATA
fig2_sf <- tract_final_spatial %>% 
  dplyr::select(Tract_FIPS, nevi) %>% 
  dplyr::left_join(ndi_clean, by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean, by = "Tract_FIPS") %>% 
  dplyr::mutate(nevi_q = ntile(nevi, 4) %>% as.factor(),
                ndi_q = ntile(ndi, 4) %>% as.factor(),
                svi_q = ntile(svi, 4) %>% as.factor()) 

### CREATE: Maps for NEVI, NDI, SVI
red_fill <- c('#F6DECC', '#E59E66', '#d55e00', '#954100') # "#fee5d9","#fcae91","#fb6a4a","#cb181d"
fig2_toxpi <- gen_fig2_main(dfin = fig2_sf, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "nevi_q", fill_color = red_fill, fill_label = "Neighborhood Environmental\nVulnerability Index Quartile") 
fig2_ndi <- gen_fig2_part(dfin = fig2_sf, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "ndi_q", fill_color =  red_fill, fill_label = "Neighborhood Deprivation Index\nQuartile", fill_label_just = 0.5, fill_increment = 0.1) 
fig2_svi <- gen_fig2_part(dfin = fig2_sf, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "svi_q", fill_color =  red_fill, fill_label = "Social Vulnerability Index\nQuartile", fill_label_just = 0.5, fill_increment = 0.2) 
## MERGE: Maps
fig2 <- ggarrange(fig2_toxpi, fig2_ndi, fig2_svi, ncol = 3, labels = c("A","B","C")) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
# fig2 <- ggarrange(fig2_toxpi, ggarrange(fig2_ndi, fig2_svi, nrow = 2, labels = "B", font.label = list(size = 25)), ncol = 2, labels = "A", font.label = list(size = 25)) + theme(plot.margin = margin(t = 0, r = 0, b = 2, l = 0, "cm"))
fig2
ggsave('figures and tables/figures/fig2.png', width = 13, height = 6) # pixels: 1200 x 900 width = 13, height = 12
ggsave('figures and tables/figures/eps/fig2.eps', width = 13, height = 6)
```

### 2.3. Figure 3 / Supplemental Figure 2 - Scatter plots NEVI vs. NDI/SVI

```{r}
### CREATE: Function to generate scatterplots
  # Ref, stat_cor: https://www.rdocumentation.org/packages/ggpubr/versions/0.4.0/topics/stat_cor
gen_fig3_scatterplot <- function(datain, var, var_label, var_breaks){
  plot_scatter <- ggplot(datain, aes(x = nevi, y = !!sym(var), color = nevi_domain)) +
    geom_point(alpha = 0.5, size = 0.8) + #  geom_smooth(method = lm) +
    ggpubr::stat_cor(aes(label = ..r.label..), method = "spearman", label.x.npc = 0.6, label.y.npc = 0.25, p.accuracy = 0.001, size = 6, color = "black") + # "~`,`~" # label.x.npc = 0.7, size = 4
    # ggpubr::stat_cor(aes(label = ..p.label..), method = "spearman", label.x.npc = 0.7, label.y.npc = 0.1, p.accuracy = 0.001, size = 4, color = "black") + # "~`,`~"
    facet_grid(borough ~ nevi_domain) + 
    scale_color_manual(values = c("#D55E00","#0072B2","#009E73","#E69F00","#CC79A7")) +
    scale_x_continuous(breaks = seq(-1, 0.8, 0.2), minor_breaks = seq(-1, 0.9, 0.1)) +
    scale_y_continuous(breaks = seq(-2, 6, var_breaks), minor_breaks = seq(-2, 6, var_breaks/2)) +
    theme_bw() +
    labs(x = "Neighborhood Environmental Vulnerability Index", y = var_label) +
    theme(legend.position = "none",
          axis.title.x = element_text(size = 20, margin = margin(t = 10)),
          axis.title.y = element_text(size = 20, margin = margin(r = 10)),
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          strip.text.x = element_text(size = 14),
          strip.text.y = element_text(size = 14))
  return(plot_scatter)
}

### DATA PREP
fig3_nevi_df <- tract_final %>% 
  dplyr::select(Tract_FIPS, borough, nevi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  tidyr::gather(key = nevi_domain, value = nevi, nevi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  dplyr::mutate(nevi_domain = case_when(nevi_domain == "nevi" ~ "Overall:\nNeighborhood Environmental\nVulnerability Index",
                                       nevi_domain == "score_demo" ~ "Domain:\nDemographic Score",
                                       nevi_domain == "score_economic" ~ "Domain:\nEconomic Score",
                                       nevi_domain == "score_residential" ~ "Domain:\nResidential Score",
                                       nevi_domain == "score_healthstatus" ~ "Domain:\nHealth Status Score") %>% 
                                       factor(levels = c("Overall:\nNeighborhood Environmental\nVulnerability Index","Domain:\nDemographic Score","Domain:\nEconomic Score","Domain:\nResidential Score","Domain:\nHealth Status Score")))
### MERGE with NDI/SVI data
fig3_df <- fig3_nevi_df %>%
  dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS)) %>% 
  dplyr::left_join(ndi_clean %>% dplyr::select(-borough), by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean %>% dplyr::select(-borough), by = "Tract_FIPS")
### CREATE: Plots
fig3_ndi <- gen_fig3_scatterplot(datain = fig3_df, var = "ndi", var_label = "Neighborhood Deprivation Index", var_breaks = 2) # NDI
figs2_svi <- gen_fig3_scatterplot(datain = fig3_df, var = "svi", var_label = "Social Vulnerability Index", var_breaks = 0.2) # SVI
### EXPORT: Plots
fig3_ndi
ggsave('figures and tables/figures/fig3.png', width = 15, height = 12)
ggsave('figures and tables/figures/eps/fig3.eps', device = cairo_ps, width = 15, height = 12)
figs2_svi
ggsave('figures and tables/figures/figs2.png', width = 15, height = 12)
ggsave('figures and tables/figures/eps/figs2.eps', device = cairo_ps, width = 15, height = 12)
```

### 2.4. Figure 4 - NEVI Cluster Map + Cluster Profile

```{r}
## CHECK WHICH CLUSTERS TRACTS WERE IN
tract_final %>% filter(Tract_FIPS %in% c('36047051900','36081067100')) %>% select(Tract_FIPS, borough, nevi, nevi_cluster, score_demo, score_economic, score_residential, score_healthstatus) # Queens tract: 4, Kings tract: 6
#View where on map: https://popfactfinder.planning.nyc.gov/#11.95/40.72281/-73.95688
# library(leaflet)
# tract_final_spatial_tempproj <- st_transform(tract_final_spatial, crs = '+proj=longlat +datum=WGS84')
# tract_final_spatial_tempproj_subset <- tract_final_spatial_tempproj %>% filter(Tract_FIPS %in% c('36047051900','36081067100'))
# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = tract_final_spatial_tempproj, color = "blue", label = tract_final$Tract_FIPS,
#               popup = c(paste0('GEOID: ', tract_final$Tract_FIPS))) %>%
#   addPolygons(data = tract_final_spatial_tempproj %>% filter(Tract_FIPS %in% c('36047051900','36081067100')), color = "red", label = tract_final_spatial_tempproj$Tract_FIPS,
#               popup = c(paste0('GEOID: ', tract_final$Tract_FIPS)))

## CREATE: PART 1 - CLUSTER PROFILES
# Colors
# Explore color options
  # colorBlindness::displayAllColors(paletteMartin, color="white")
  # colors_colorblindsafe <- paletteMartin[c(5, 6, 9, 11, 14, 15)] %>% unname()
colors_colorblindsafe <- c('#ffff6d','#ffb6db','#24ff24','#6db6ff','#920000','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nevi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
fig4_part1_df <- tract_final %>% 
  dplyr::group_by(nevi_cluster) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nevi = mean(nevi),
                   q1_nevi = quantile(nevi, 0.25),
                   q3_nevi = quantile(nevi, 0.75),
                   iqr_nevi = paste0(round(q1_nevi, 2), "-", round(q3_nevi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nevi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nevi_cat = case_when(nevi_cat_prelim == 'mean_demo_score'         ~ nevi_cat_levels[1],
                                    nevi_cat_prelim == 'mean_economic_score'     ~ nevi_cat_levels[2],
                                    nevi_cat_prelim == 'mean_residential_score'  ~ nevi_cat_levels[3],
                                    nevi_cat_prelim == 'mean_healthstatus_score' ~ nevi_cat_levels[4]) %>% factor(nevi_cat_levels),
                nevi_cluster_label = paste0("Cluster ", nevi_cluster, " (n = ", n_obs, ",\nMean NEVI = ", round(mean_nevi,2), ")"))
# Plotting
fig4_part1_prelim <- ggplot(fig4_part1_df, aes(x = nevi_cat, y = mean, fill = nevi_cluster_label, pattern = nevi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") + # settings if legend patterns do not show: pattern_density = 0.3, pattern_key_scale_factor = 0.6
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nevi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nEnvironmental\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
fig4_part1_plot_build <- ggplot_build(fig4_part1_prelim)
for(i in 1:6){
  fig4_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
fig4_part1 <- ggplot_gtable(fig4_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_fig4_part2 <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
fig4_part2 <- gen_fig4_part2(dfin = tract_final_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "nevi_cluster", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Environmental Vulnerability Index Cluster") 

## COMBINED PLOT
fig4b <- ggarrange(fig4_part1, ggarrange(fig4_part2, ggplot() + theme_void(), ncol = 2), nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"))
fig4b
# EXPORT
ggsave('figures and tables/figures/fig4_part.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12
ggsave('figures and tables/figures/eps/fig4_part.eps', width = 7, height = 9)
# View average NEVI domains scores by cluster for text
fig4b_part1_df %>% distinct(nevi_cluster, mean_nevi, iqr_nevi)

```

### 2.5. Figure 5 - NEVI Cluster Subdomains Heatmap

```{r}
### CREATE: Heat maps to visualize clustering by subdomain
## Specify Labels
subdomain_vector <- c(
  'score_demo_age', 'score_demo_femaleled', 'score_demo_immigration', 'score_demo_disability', 'score_demo_singleparent', 'score_demo_mobility', 'score_demo_livealone',
  'score_economic_incomepoverty', 'score_economic_servicemanual', 'score_economic_gini', 'score_economic_employment', 'score_economic_education', 'score_economic_vehicleavail',
  'score_residential_popdensity', 'score_residential_groupquarters', 'score_residential_occperroom', 'score_residential_structage', 'score_residential_structattach', 'score_residential_move1yr', 'score_residential_vacancy',
  'score_healthstatus_lifestyle', 'score_healthstatus_condition', 'score_healthstatus_preventive', 'score_healthstatus_lackinsurance'
)
subdomain_label_vector <- c(
  'Age','Female-Led Households','Immigration','Disability','Single Parent Households','Transportation','Single Households',
  'Income and Poverty','Occupation','Income Inequality','Employment Status','Education','Vehicle Availability',
  'Population Density','Group Quarters','Household Density','Age of Housing Structure','Units in Housing Structure','Residential Mobility','Vacancy',
  'Health Behaviors','Health Conditions','Prevention Practices','Health Insurance Status'
)
domain_label_vector <- c('Demographic\n Domain', 'Economic Indicators\n Domain', 'Residential\n Domain', 'Health Status\n Domain')
## PREPARE DATA
fig5_df<- tract_final %>%
  dplyr::select(nevi_cluster, score_demo_age, score_demo_femaleled, score_demo_immigration, score_demo_disability, score_demo_singleparent, score_demo_mobility, score_demo_livealone,
                score_economic_incomepoverty, score_economic_servicemanual, score_economic_gini, score_economic_employment, score_economic_education, score_economic_vehicleavail,
                score_residential_popdensity, score_residential_groupquarters, score_residential_occperroom, score_residential_structage, score_residential_structattach, score_residential_move1yr, score_residential_vacancy,
                score_healthstatus_lifestyle, score_healthstatus_condition, score_healthstatus_preventive, score_healthstatus_lackinsurance) %>%
  gtsummary::tbl_summary(by = nevi_cluster, statistic = all_continuous() ~ "{median}") %>% 
  dplyr::as_tibble() %>%
  dplyr::rename(subdomain = tidyselect::contains('Characteristic')) %>%
  dplyr::rename_at(vars(tidyselect::matches('\\d')), # Identifies cluster columns (2-7) to rename
                   .funs = ~ paste0(stringr::str_extract(., '\\d'),'\n(n', stringr::str_extract(., ' = \\d+'),')')) %>% # Renames to desired cluster label from tbl_summary output (e.g., "**1**, N = 435" --> "1\n(n = 435)")
  dplyr::mutate(
    subdomain_label = case_when(TRUE ~ rlang::set_names(subdomain_label_vector, nm = subdomain_vector)[subdomain]) %>% # Use a named vector to specify labels for certain variable names
                               factor(levels = subdomain_label_vector, ordered = TRUE), 
    domain = case_when(stringr::str_detect(subdomain, 'demo') ~ domain_label_vector[1],
                       stringr::str_detect(subdomain, 'economic') ~ domain_label_vector[2],
                       stringr::str_detect(subdomain, 'residential') ~ domain_label_vector[3],
                       stringr::str_detect(subdomain, 'healthstatus') ~ domain_label_vector[4]) %>% 
                       factor(levels = domain_label_vector, ordered = TRUE)) %>% 
  tidyr::pivot_longer(cols = contains('\n'), names_to = 'cluster_label', values_to = 'median') %>% 
  dplyr::mutate(median = as.numeric(median)) %>%
  dplyr::group_by(subdomain_label) %>% 
  dplyr::mutate(median_scaled = scale(median)[,1]) 

##### CREATE: heatmap 
ggplot(data = fig5_df, aes(x = cluster_label, y = subdomain_label, fill = median_scaled)) +
  geom_tile() + 
  facet_grid(domain ~ ., scales = 'free_y', space = 'free_y') +
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = 'white', high = 'red') +
  labs(x = 'NEVI Cluster', y = 'Subdomain', fill = "Median Score (Scaled)") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = 'white', color = 'white'),
        axis.title.x = element_text(size = 20, margin = margin(t = 10)), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 20, margin = margin(t = 5)), axis.text.y = element_text(size = 15), 
        strip.text = element_text(size = 16),
        legend.title = element_text(size = 16), legend.text = element_text(size = 14),
        legend.position = 'top', legend.key.width = unit(1.5, 'cm'), legend.spacing.x = unit(1, 'cm'))

## EXPORT
ggsave('figures and tables/figures/fig5.png', width = 10, height = 13)
ggsave('figures and tables/figures/eps/fig5.eps', width = 10, height = 13)
```

## 3. Supplemental Figures and Tables

### 3.1. S Figure 1 - Box plots of NEVI and Domain Distributions

```{r}
# note changed colors for overall and residential
figs1_df <- tract_final %>% 
  dplyr::select(Tract_FIPS, borough, nevi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  tidyr::gather(key = index_type, value = index, nevi, score_demo, score_economic, score_residential, score_healthstatus) %>% 
  dplyr::mutate(index_type = case_when(index_type == "nevi" ~ "Overall:\nNEVI",
                                       index_type == "score_demo" ~ "Domain:\nDemographic\nScore",
                                       index_type == "score_economic" ~ "Domain:\nEconomic\nScore",
                                       index_type == "score_residential" ~ "Domain:\nResidential\nScore",
                                       index_type == "score_healthstatus" ~ "Domain:\nHealth Status\nScore") %>% 
                                       factor(levels = c("Overall:\nNEVI","Domain:\nDemographic\nScore","Domain:\nEconomic\nScore","Domain:\nResidential\nScore","Domain:\nHealth Status\nScore",
                                                         'Neighborhood Deprivation Index','Social Vulnerability Index')),
                part = 'NEVI') %>% 
  rbind(ndi_clean %>% dplyr::mutate(index_type = 'Neighborhood Deprivation Index', part = 'NDI') %>% rename(index = ndi),
        svi_clean %>% dplyr::mutate(index_type = 'Social Vulnerability Index', part = 'SVI') %>% rename(index = svi)) 
### CREATE: Plots
  # NEVI
figs1a <- ggplot(figs1_df %>% filter(part == 'NEVI'), aes(y = borough, x = index, fill = index_type)) +
  geom_boxplot() +
  facet_grid(index_type ~ ., scale = "free") +
  # labs(x = "Index", y = "Borough") +
  labs(title = "Neighborhood Environmental Vulnerability Index") +
  scale_fill_manual(values = c("#D55E00","#0072B2","#009E73","#E69F00","#CC79A7")) +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), strip.text.y = element_text(size = 20), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
  # NDI
figs1b <- ggplot(figs1_df %>% filter(part == 'NDI'), aes(y = borough, x = index, fill = index_type)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#D55E00")) +
  labs(title = "Neighborhood Deprivation Index") +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
  # SVI
figs1c <- ggplot(figs1_df %>% filter(part == 'SVI'), aes(y = borough, x = index, fill = index_type)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#D55E00")) +
  labs(title = "Social Vulnerability Index") +
  theme_bw() +
  theme(legend.position = "none", axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), plot.title = element_text(face = "bold", hjust = 0.5, size = 20))
### EXPORT: Plots
# fig3_labs <- c("A","B","C") # c("Neighborhood Environmental Vulnerability Index","Neighborhood Deprivation Index","Social Vulnerability Index")
figs1 <- ggarrange(figs1a, figs1b, figs1c, nrow = 3, font.label = list(size = 25), align = "v", heights = c(4,1,1)) #labels = fig3_labs,
annotate_figure(figs1,left = text_grob("Borough", rot = 90, hjust = 1, size = 20), bottom = text_grob("Index", size = 20))
ggsave('figures and tables/figures/figs1.png', width = 15, height = 16)
ggsave('figures and tables/figures/eps/figs1.eps', width = 15, height = 16)
```

### 3.2. S Figure 3 - Race and ethnicity Sensitivity Analyssis - Score Distributions

```{r}
### Clean data 
# CREATE: Function
clean_toxpi_sa <- function(datain, databorough){
  dataout <- datain %>% 
    dplyr::rename(Tract_FIPS = Source, nevi = `ToxPi Score`) %>% 
    dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()) %>% 
    dplyr::select(-c(`HClust Group`, `KMeans Group`, Name)) %>% 
    # Demographics
    dplyr::rename_at(vars(starts_with('DemographicsAge')), funs(paste0('score_demo_age'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsFemaleLed')), funs(paste0('score_demo_femaleled'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsRaceEth!')), funs(paste0('score_demo_raceeth'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsImmigration')), funs(paste0('score_demo_immigration'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsDisability')), funs(paste0('score_demo_disability'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsSingleParent')), funs(paste0('score_demo_singleparent'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsMobility')), funs(paste0('score_demo_mobility'))) %>% 
    dplyr::rename_at(vars(starts_with('DemographicsLiveAlone')), funs(paste0('score_demo_livealone'))) %>% 
    # Economic
    dplyr::rename_at(vars(starts_with('Economic IndicatorsIncomePoverty')), funs(paste0('score_economic_incomepoverty'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsServiceManualJobs')), funs(paste0('score_economic_servicemanual'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsGini')), funs(paste0('score_economic_gini'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsEmployment')), funs(paste0('score_economic_employment'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsEducation')), funs(paste0('score_economic_education'))) %>% 
    dplyr::rename_at(vars(starts_with('Economic IndicatorsVehicleAvail')), funs(paste0('score_economic_vehicleavail'))) %>% 
    # Residential
    dplyr::rename_at(vars(starts_with('Residential DensityPopDensity')), funs(paste0('score_residential_popdensity'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityGroupQuarters')), funs(paste0('score_residential_groupquarters'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityOccPerRoom')), funs(paste0('score_residential_occperroom'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityStrAge')), funs(paste0('score_residential_structage'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityStrAttached')), funs(paste0('score_residential_structattach'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityMove1Yr')), funs(paste0('score_residential_move1yr'))) %>% 
    dplyr::rename_at(vars(starts_with('Residential DensityVacancy')), funs(paste0('score_residential_vacancy'))) %>% 
    # Health status
    dplyr::rename_at(vars(starts_with('Health StatusLifestyle')), funs(paste0('score_healthstatus_lifestyle'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusCondition')), funs(paste0('score_healthstatus_condition'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusPreventive')), funs(paste0('score_healthstatus_preventive'))) %>% 
    dplyr::rename_at(vars(starts_with('Health StatusLackInsurance')), funs(paste0('score_healthstatus_lackinsurance'))) %>% 
    dplyr::mutate(score_economic = (score_economic_incomepoverty + score_economic_servicemanual + score_economic_gini + score_economic_employment + score_economic_education + score_economic_vehicleavail)/6,
                  score_residential = (score_residential_popdensity + score_residential_groupquarters + score_residential_occperroom + score_residential_structage + score_residential_structattach + score_residential_move1yr + score_residential_vacancy)/7,
                  score_healthstatus = (score_healthstatus_lifestyle + score_healthstatus_condition + score_healthstatus_preventive + score_healthstatus_lackinsurance)/4) %>% 
    dplyr::left_join(databorough, by = "Tract_FIPS")
  return(dataout)
}

# DATA CLEANING
  # Race/eth: no overlapping
tract_toxpi_raceeth_no_olap_df <- clean_toxpi_sa(tract_toxpi_pre_raceeth_no_olap, tract_nyc_borough) %>% 
  dplyr::mutate(score_demo = (score_demo_age + score_demo_femaleled + score_demo_raceeth + score_demo_immigration + score_demo_disability + score_demo_singleparent + score_demo_mobility + score_demo_livealone)/8) 

##### PLOTS
### BOXPLOT
# PREP data
figs3_df <- rbind(tract_final %>% dplyr::select(nevi, score_demo, borough) %>% dplyr::mutate(index_type = "Without Race and Ethnicity \nCategories (Main)"),
               tract_toxpi_raceeth_no_olap_df %>% dplyr::select(nevi, score_demo, borough) %>% dplyr::mutate(index_type = "With Race and Ethnicity\nCategories")) %>% 
  dplyr::mutate(all = "All Boroughs", index_type = factor(index_type, levels = c("Without Race and Ethnicity \nCategories (Main)",
                                                           "With Race and Ethnicity\nCategories")))

# CREATE: Plots
  # NEVI
figs3a <- ggplot(figs3_df, aes(x = nevi, fill = index_type)) +
  geom_boxplot(aes(y = borough)) +
  geom_boxplot(aes(y = all)) +
  scale_y_discrete(limits = rev) +
  geom_hline(yintercept = 5.5, color = "gray20", linetype = "dashed") +
  labs(title = "Overall NEVI", fill = "NEVI:\nRace and Ethnicity Categorization") +
  scale_fill_manual(values = c("#D55E00", "gray40", "gray60", "gray80")) + # limits = rev
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() +
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), panel.grid.major.y = element_blank(), strip.text.y = element_text(size = 20), plot.title = element_text(face = "bold", hjust = 0.5, size = 20), legend.title = element_text(size = 16), legend.text = element_text(size = 14))
  # Domain: Demographic 
figs3b <- ggplot(figs3_df, aes(x = score_demo, fill = index_type)) +
  geom_boxplot(aes(y = borough)) +
  geom_boxplot(aes(y = all)) +
  scale_y_discrete(limits = rev) +
  geom_hline(yintercept = 5.5, color = "gray20", linetype = "dashed") +
  labs(title = "Domain: Demographic Score", fill = "Demographic Domain:\nRace and Ethnicity Categorization") +
  scale_fill_manual(values = c("#0072B2", "gray40", "gray60", "gray80")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() +
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), panel.grid.major.y = element_blank(), plot.title = element_text(face = "bold", hjust = 0.5, size = 20), legend.title = element_text(size = 16), legend.text = element_text(size = 14))
### MERGE AND EXPORT: Plots
figs3 <- ggarrange(figs3a, figs3b, nrow = 2, font.label = list(size = 25), align = "v", heights = c(1,1,1)) +
  theme(plot.margin=unit(c(0,0,0.2,0.2),"in"),
        panel.background = element_rect(fill = "white", color = "white"))

figs3_export <- annotate_figure(figs3,left = text_grob("Borough", rot = 90, hjust = 1, size = 20), bottom = text_grob("Index", size = 20))
ggsave('figures and tables/figures/figs3.png', plot = figs3_export, width = 10, height = 10)
ggsave('figures and tables/figures/eps/figs3.eps', plot = figs3_export, width = 10, height = 10)
```

### 3.3. S Figure 4 - Race and Ethnicity Cluster Map + Profile (Similar to Figure 4)

```{r}
## CREATE: Clusters: NEVI with non-overlapping race and ethnicity features
set.seed(123)
  # Get slice weights
w_raceeth <- sapply(sapply(names(tract_toxpi_pre_raceeth_no_olap)[-c(1:5)],function(x) strsplit(x, "!")),"[",2)
w_raceeth <- sapply(strsplit(w_raceeth,split="/"),function(x) {y <- ifelse(length(x)==2,x[2],1);as.numeric(x[1])/as.numeric(y)})
  # Generate cluster
hc_raceeth <- hclust(dist(tract_toxpi_pre_raceeth_no_olap[,-c(1:5)]*rep(w_raceeth,each=nrow(tract_toxpi_pre_raceeth_no_olap))), method="complete")
nevi_cluster_result_raceeth <- cutree(hc_raceeth, k = 6) # Cut into 6 clusters using HClusts 
  # Create data frame for cluster data
tract_nevi_cluster_raceeth <- tract_toxpi_pre_raceeth_no_olap %>% 
  dplyr::mutate(Tract_FIPS = Source %>% as.character() %>% trimws(),
                nevi_cluster_orig = nevi_cluster_result_raceeth %>% as.factor(),
                nevi_cluster = case_when(
                  nevi_cluster_orig == "1" ~ "6",
                  nevi_cluster_orig == "2" ~ "5",
                  nevi_cluster_orig == "3" ~ "4",
                  nevi_cluster_orig == "4" ~ "3",
                  nevi_cluster_orig == "5" ~ "1",
                  nevi_cluster_orig == "6" ~ "2"
                ) %>% as.factor()) %>% 
  dplyr::select(Tract_FIPS, nevi_cluster)
  # Merge with cleaned df
figs4_df <- tract_toxpi_raceeth_no_olap_df %>% 
  dplyr::left_join(tract_nevi_cluster_raceeth, by = 'Tract_FIPS')
figs4_spatial <- tract_nyc_spatial %>% 
  dplyr::inner_join(figs4_df %>% dplyr::mutate(Tract_FIPS = as.character(Tract_FIPS) %>% trimws()), by = "Tract_FIPS")

## CHECK CLUSTERS
# scaled_tract_toxpi_pre_raceeth_no_olap = scale(tract_toxpi_pre_raceeth_no_olap[-c(1:5)])
# mydist <-function(x)dist(x, method="euclidian")
# mycluster <- function(x,k) list(cluster=cutree(hclust(mydist(x), method = "complete"),k=k))
# gap_stat_10_raceeth_no_olap <- clusGap(scaled_tract_toxpi_pre_raceeth_no_olap, FUN = mycluster, K.max = 10, B = 50)
# library(factoextra)
# fviz_gap_stat(gap_stat_10_raceeth_no_olap) # choose 6 clusters based on this plot and what we observed when characterizing the clusters.



## CREATE: PART 1 - CLUSTER PROFILES
# Colors
colors_colorblindsafe <- c('#ffff6d','#ffb6db','#6db6ff','#24ff24','#920000','#490092') 

# Alt: colors_colorblindsafe <- safeColors[2:7] %>% unname()
# Ref: https://www.r-graph-gallery.com/circular-barplot.html
nevi_cat_levels <- c('Demographics', 'Economic', 'Residential', 'Health Status')
# Data Prep
figs4_part1_df <- figs4_df %>% 
  dplyr::group_by(nevi_cluster) %>% 
  dplyr::summarize(n_obs = n(),
                   mean_nevi = mean(nevi),
                   q1_nevi = quantile(nevi, 0.25),
                   q3_nevi = quantile(nevi, 0.75),
                   iqr_nevi = paste0(round(q1_nevi, 2), "-", round(q3_nevi,2)),
                   mean_demo_score = mean(score_demo),
                   mean_economic_score = mean(score_economic),
                   mean_residential_score = mean(score_residential),
                   mean_healthstatus_score = mean(score_healthstatus)) %>% 
  tidyr::gather(nevi_cat_prelim, mean, mean_demo_score:mean_healthstatus_score) %>% 
  dplyr::mutate(nevi_cat = case_when(nevi_cat_prelim == 'mean_demo_score'         ~ nevi_cat_levels[1],
                                    nevi_cat_prelim == 'mean_economic_score'     ~ nevi_cat_levels[2],
                                    nevi_cat_prelim == 'mean_residential_score'  ~ nevi_cat_levels[3],
                                    nevi_cat_prelim == 'mean_healthstatus_score' ~ nevi_cat_levels[4]) %>% factor(nevi_cat_levels),
                nevi_cluster_label = paste0("Cluster ", nevi_cluster, " (n = ", n_obs, ",\nMean NEVI = ", round(mean_nevi,2), ")"))
# Plotting
figs4_part1_prelim <- ggplot(figs4_part1_df, aes(x = nevi_cat, y = mean, fill = nevi_cluster_label, pattern = nevi_cat)) +
  ggpattern::geom_bar_pattern(stat = "identity", color = "black") +
  geom_text(aes(label = round(mean, 2), y = mean + 0.25), size = 4) + # y = mean + 0.5
  coord_polar(start = (3*pi)/2, direction = -1, clip = "off") +
  ylim(-0.2, 1.1) + #1.1
  scale_fill_manual(values = colors_colorblindsafe, labels = c("1","2","3","4","5","6")) +
  ggpattern::scale_pattern_manual(values = c("circle","stripe","crosshatch","none")) +
  facet_wrap(. ~ nevi_cluster_label, nrow = 2) +
  labs(fill = "Neighborhood\nEnvironmental\nVulnerability Index\nCluster", pattern = "Domain Score") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(pattern = "none"), nrow = 2, title.position = "top", title.hjust = 0.5, order = 1), # fill = FALSE 
         pattern = guide_legend(override.aes = list(fill = "white"), nrow = 6, title.position = "top", title.hjust = 0.5, order = 2)) +
  theme(legend.position = "right",
        legend.title = element_text(face = "bold"),
        legend.box = 'vertical',
        axis.title = element_blank(),
        axis.text = element_blank(),
        strip.text.x = element_text(size = 12, face = "bold"),
        panel.grid = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm"),
        panel.spacing = unit(0, "lines")) # strip.background.y = element_rect("transparent")
figs4_part1_plot_build <- ggplot_build(figs4_part1_prelim)
for(i in 1:6){
  figs4_part1_plot_build[["layout"]][["panel_params"]][[i]][["r.range"]][2] <- 0.45
}
figs4_part1 <- ggplot_gtable(figs4_part1_plot_build)


## CREATE: PART 2 - CLUSTER MAP
gen_figs4_part2 <- function(dfin, dfexcl, dfborough, fill_var, fill_color, fill_label, fill_increment){
  plot_choro <- ggplot() + 
    geom_sf(data = dfin, aes(fill = !!sym(fill_var)), color = NA) + 
    geom_sf(data = dfexcl, color = "gray90", fill = "gray90") + 
    geom_sf(data = dfborough, color = 'gray20', fill = NA, size = 0.6) +
    theme_minimal() + 
    scale_fill_manual(values = fill_color, guide = guide_legend(direction = "horizontal", title.position = "top")) +
    labs(fill = fill_label) + 
    # guides(fill = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "none", # legend.title = element_text(face = "bold", size = 12), legend.text = element_text(size = 9), legend.spacing.x = unit(0.5, 'cm'), 
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank(),
          panel.grid = element_blank(),
          plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")) 
  return(plot_choro)
}
figs4_part2 <- gen_figs4_part2(dfin = figs4_spatial, dfexcl = tract_exclude_spatial, dfborough = borough_nyc_spatial, fill_var = "nevi_cluster", fill_color = colors_colorblindsafe, fill_label = "Neighborhood Environmental Vulnerability Index Cluster") 

## COMBINED PLOT
figs4b <- ggarrange(figs4_part1, figs4_part2, nrow = 2) + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, "cm"), panel.background = element_rect(fill = 'white', color = 'white'))
figs4b
# EXPORT
ggsave('figures and tables/figures/figs4.png', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12
ggsave('figures and tables/figures/eps/figs4.eps', width = 7, height = 9) # pixels: 1200 x 900 width = 13, height = 12

```

### 3.4. S Table 1 & Summary Statistics for Text

```{r}
# Prep data
stab1_df <- tract_final %>% 
  dplyr::left_join(ndi_clean, by = "Tract_FIPS") %>% 
  dplyr::left_join(svi_clean, by = "Tract_FIPS")


# Function to generate summary stats
gen_stab1 <- function(dfin, var, var_label){
  var <- sym(var)
  overall <- dfin %>% 
    dplyr::summarize(mean = mean(!!var), sd = sd(!!var), median = median(!!var), min = min(!!var), max = max(!!var), q1 = quantile(!!var, probs = 0.25), q3 = quantile(!!var, probs = 0.75), iqr = paste0(q1 %>% round(2) %>% format(nsmall = 2),"-",q3 %>% round(2) %>% format(nsmall = 2)), median_iqr = paste0(median %>% round(2) %>% format(nsmall = 2)," (IQR = ",iqr,")"), median_iqr2 = paste0(median %>% round(2) %>% format(nsmall = 2),", IQR = ",iqr), median_iqr3 = paste0("median = ", median_iqr2)) %>% 
    dplyr::mutate(borough = "Overall")
  byborough <- dfin %>% 
    dplyr::group_by(borough) %>% 
    dplyr::summarize(mean = mean(!!var), sd = sd(!!var), median = median(!!var), min = min(!!var), max = max(!!var), q1 = quantile(!!var, probs = 0.25), q3 = quantile(!!var, probs = 0.75), iqr = paste0(q1 %>% round(2) %>% format(nsmall = 2),"-",q3 %>% round(2) %>% format(nsmall = 2)), median_iqr = paste0(median %>% round(2) %>% format(nsmall = 2)," (IQR = ",iqr,")"), median_iqr2 = paste0(median %>% round(2) %>% format(nsmall = 2),", IQR = ",iqr), median_iqr3 = paste0("median = ", median_iqr2)) %>% 
    dplyr::mutate(borough = paste0("   ", borough))
  combined <- rbind(overall, byborough) %>% 
    dplyr::mutate(score = var_label) %>% 
    dplyr::relocate(score, borough, mean, sd, median, iqr, min, max, median_iqr, median_iqr2, median_iqr3, .before = mean)
  return(combined)
}

# Generate summary stats
stab1_full <- rbind(gen_stab1(stab1_df, "nevi", "Neighborhood Environmental Vulnerability Index (NEVI)")
                   ,gen_stab1(stab1_df, "ndi", "Neighborhood Deprivation Index (NDI)")
                   ,gen_stab1(stab1_df, "svi", "Social Vulnerability Index (SVI)")
                   ,gen_stab1(stab1_df, "score_demo", "NEVI Domain: Demographics")
                   ,gen_stab1(stab1_df, "score_economic", "NEVI Domain: Economic Indicators")
                   ,gen_stab1(stab1_df, "score_residential", "NEVI Domain: Residential Characteristics")
                   ,gen_stab1(stab1_df, "score_healthstatus", "NEVI Domain: Health Status"))

# text_summary %>% View()
export(stab1_full, 'figures and tables/tables/stab1_full.xlsx')

# OVERALL CORRELATIONS
cor.test(stab1_df$nevi, stab1_df$ndi, method = "spearman")
cor.test(stab1_df$nevi, stab1_df$svi, method = "spearman")


```

### 3.5. S Table 5: NEVI Cluster summaries

```{r}
# Function to generate summary stats
gen_stab4 <- function(dfin, var){
  var <- sym(var)
  var_median <- sym(paste0('median_iqr_', var))
  nevi_cluster_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster) %>% 
    dplyr::summarize(iqr_prelim = quantile(!!var, c(0.25, 0.75)) %>% round(2) %>% format(2)) %>% 
    dplyr::group_by(nevi_cluster) %>% 
    dplyr::summarize(iqr = paste(iqr_prelim, collapse = '-'))
  tab_summary <- dfin %>% 
    dplyr::group_by(nevi_cluster) %>%
    dplyr::summarize(median_nevi = median(!!var) %>% round(2) %>% format(nsmall = 2)) %>% 
    dplyr::left_join(nevi_cluster_summary, by = 'nevi_cluster') %>% 
    dplyr::summarize(nevi_cluster = nevi_cluster,
                     median_iqr = paste0(median_nevi,' (',iqr,')'))
  return(tab_summary)
}
# Generate summary stats
stab4 <- tract_final %>% 
  janitor::tabyl(nevi_cluster) %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  dplyr::transmute(nevi_cluster = nevi_cluster,
                   n_percent = paste0('(n = ', n,', ', percent,')')) %>% 
  dplyr::left_join(gen_stab4(tract_final, 'nevi') %>% dplyr::rename(nevi_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_age') %>% dplyr::rename(score_demo_age_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_femaleled') %>% dplyr::rename(score_demo_femaleled_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_immigration') %>% dplyr::rename(score_demo_immigration_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_disability') %>% dplyr::rename(score_demo_disability_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_singleparent') %>% dplyr::rename(score_demo_singleparent_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_mobility') %>% dplyr::rename(score_demo_mobility_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_demo_livealone') %>% dplyr::rename(score_demo_livealone_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_incomepoverty') %>% dplyr::rename(score_economic_incomepoverty_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_servicemanual') %>% dplyr::rename(score_economic_servicemanual_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_gini') %>% dplyr::rename(score_economic_gini_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_employment') %>% dplyr::rename(score_economic_employment_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_education') %>% dplyr::rename(score_economic_education_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_economic_vehicleavail') %>% dplyr::rename(score_economic_vehicleavail_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_popdensity') %>% dplyr::rename(score_residential_popdensity_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_groupquarters') %>% dplyr::rename(score_residential_groupquarters_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_occperroom') %>% dplyr::rename(score_residential_occperroom_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_structage') %>% dplyr::rename(score_residential_structage_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_structattach') %>% dplyr::rename(score_residential_structattach_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_move1yr') %>% dplyr::rename(score_residential_move1yr_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_residential_vacancy') %>% dplyr::rename(score_residential_vacancy_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_healthstatus_lifestyle') %>% dplyr::rename(score_healthstatus_lifestyle_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_healthstatus_condition') %>% dplyr::rename(score_healthstatus_condition_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_healthstatus_preventive') %>% dplyr::rename(score_healthstatus_preventive_median_iqr = median_iqr)) %>%
  dplyr::left_join(gen_stab4(tract_final, 'score_healthstatus_lackinsurance') %>% dplyr::rename(score_healthstatus_lackinsurance_median_iqr = median_iqr)) %>% 
  t()
## EXPORT
export(stab4, 'figures and tables/tables/stab4.xlsx', row.names = TRUE)

```
